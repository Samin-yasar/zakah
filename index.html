<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Zakah Calculator â€” Samin's Initiatives</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json" />

<!-- Theme & status bar colours -->
<meta name="theme-color" content="#c9a84c" />
<meta name="msapplication-navbutton-color" content="#c9a84c" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zakah Calc" />
<link rel="apple-touch-icon" href="icons/icon-192x192.png" />
<link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png" />
<link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png" />

<!-- Android / general -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="application-name" content="Zakah Calc" />
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32"   href="icons/icon-128x128.png" />

<!-- SEO / Social -->
<meta name="description" content="A comprehensive, scholarly-accurate Zakah calculator covering cash, metals, investments, and business assets. 100% private â€” all processing happens locally in your browser." />
<meta name="robots" content="index, follow" />
<meta property="og:title"       content="Zakah Calculator â€” Samin's Initiatives" />
<meta property="og:description" content="Calculate your Zakah accurately with live metal prices and multi-currency support." />
<meta property="og:type"        content="website" />

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&family=Noto+Serif+Bengali:wght@300;400;500;600;700&display=swap" />
<link rel="stylesheet" href="styles.css" />
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo-block">
      <div class="logo-icon">â˜½</div>
      <div class="logo-text">
        <h1 data-i18n="title">Zakah Calculator</h1>
        <p data-i18n="brand">Samin's Initiatives</p>
      </div>
    </div>
    <div class="header-controls">
      <div class="pill-toggle" id="langToggle">
        <button onclick="setLang('en')" id="btn-en" class="active">EN</button>
        <button onclick="setLang('bn')" id="btn-bn">à¦¬à¦¾à¦‚</button>
      </div>
      <select class="currency-select" id="currencySelect" onchange="setCurrency(this.value)">
        <option value="BDT">à§³ BDT</option>
        <option value="USD">$ USD</option>
        <option value="SAR">ï·¼ SAR</option>
        <option value="GBP">Â£ GBP</option>
        <option value="AUD">A$ AUD</option>
        <option value="INR">â‚¹ INR</option>
      </select>
    </div>
  </div>
</header>

<main>
<div class="wrap">

  <!-- HERO -->
  <div class="hero fade-up">
    <div class="hero-badge">âœ¦ <span data-i18n="badge">2026 Professional Zakah Calculator</span></div>
    <h2 data-i18n="hero_title">Calculate Your Zakah with Precision</h2>
    <p data-i18n="hero_desc">A comprehensive, scholarly-accurate calculator covering all asset categories including digital wallets, investments, and business assets.</p>
    <div class="security-banner">
      ğŸ”’ <span data-i18n="security_note">100% Secure & Open-Source â€” All data processed locally in your browser. No server. No data shared.</span>
    </div>
  </div>

  <!-- QURAN -->
  <div class="quran-banner fade-up">
    <div class="quran-arabic">ÙˆÙØ£ÙÙ‚ÙÙŠÙ…ÙÙˆØ§ Ø§Ù„ØµÙÙ‘Ù„ÙØ§Ø©Ù ÙˆÙØ¢ØªÙÙˆØ§ Ø§Ù„Ø²ÙÙ‘ÙƒÙØ§Ø©Ù</div>
    <div class="quran-trans" data-i18n="quran_trans">"Establish prayer and give Zakah." â€” Quran 2:43</div>
  </div>

  <!-- PROGRESS -->
  <div class="progress-bar fade-up">
    <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
  </div>

  <!-- SETTINGS -->
  <div class="settings-card fade-up">
    <div class="settings-card-title">âš™ <span data-i18n="calc_settings">Calculation Settings</span></div>
    <div class="settings-row">
      <div class="setting-group">
        <label data-i18n="nisab_based_on">Nisab Based On</label>
        <div class="pill-toggle" style="width:100%; justify-content:center;">
          <button onclick="setNisabType('silver')" id="btn-silver" class="active" data-i18n-btn="silver_nisab">Silver (Recommended)</button>
          <button onclick="setNisabType('gold')" id="btn-gold" data-i18n-btn="gold_nisab">Gold</button>
        </div>
      </div>
      <div class="setting-group">
        <label data-i18n="calendar_type">Calendar Type</label>
        <div class="pill-toggle" style="width:100%; justify-content:center;">
          <button onclick="setCalendar('lunar')" id="btn-lunar" class="active" data-i18n-btn="lunar">Lunar (2.5%)</button>
          <button onclick="setCalendar('solar')" id="btn-solar" data-i18n-btn="solar">Solar (2.577%)</button>
        </div>
      </div>
    </div>
    <div class="nisab-display" id="nisabDisplay">
      <div class="nisab-stat">
        <div class="nisab-stat-val" id="nisabMetalDisp">612.36g Silver</div>
        <div class="nisab-stat-label" data-i18n="nisab_weight">Nisab Weight</div>
      </div>
      <div class="nisab-stat">
        <div class="nisab-stat-val" id="nisabValueDisp">â€”</div>
        <div class="nisab-stat-label" data-i18n="nisab_value">Nisab Value</div>
      </div>
      <div class="nisab-stat">
        <div class="nisab-stat-val" id="zakahRateDisp">2.5%</div>
        <div class="nisab-stat-label" data-i18n="zakah_rate">Zakah Rate</div>
      </div>
    </div>

    <!-- LIVE PRICE PANEL -->
    <div style="margin-top:16px;">
      <div class="price-panel">
        <div class="price-panel-header">
          <div class="price-panel-title">
            <span class="live-dot loading" id="liveDot"></span>
            <span data-i18n="live_prices_title">Live Metal Prices</span>
          </div>
          <div class="price-meta">
            <span class="price-timestamp" id="priceTimestamp" data-i18n="fetching">Fetchingâ€¦</span>
            <button class="btn-refresh" id="refreshBtn" onclick="fetchPrices(true)" disabled>
              <span class="spin">â†º</span> <span data-i18n="refresh">Refresh</span>
            </button>
          </div>
        </div>
        <!-- 3-cell grid: removed "Data Source" cell -->
        <div class="price-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="price-cell">
            <div class="price-cell-label">ğŸ¥‡ <span data-i18n="gold_24k_label">Gold 24k</span></div>
            <div class="price-cell-usd" id="goldUsdLabel">â€” USD/oz</div>
            <div class="price-cell-val loading-shimmer" id="goldPriceDisplay">Loadingâ€¦</div>
            <div class="price-cell-sub" id="goldPerGramSub">per gram</div>
          </div>
          <div class="price-cell">
            <div class="price-cell-label">ğŸ¥ˆ <span data-i18n="silver_999_label">Silver 999</span></div>
            <div class="price-cell-usd" id="silverUsdLabel">â€” USD/oz</div>
            <div class="price-cell-val loading-shimmer" id="silverPriceDisplay">Loadingâ€¦</div>
            <div class="price-cell-sub" id="silverPerGramSub">per gram</div>
          </div>
          <div class="price-cell">
            <div class="price-cell-label">ğŸ’± <span data-i18n="fx_rate_label">Exchange Rate</span></div>
            <div class="price-cell-usd" id="fxBaseLabel">USD base</div>
            <div class="price-cell-val loading-shimmer" id="fxRateDisplay">Loadingâ€¦</div>
            <div class="price-cell-sub" id="fxRateSub">1 USD = ?</div>
          </div>
        </div>
        <!-- Price data disclaimer -->
        <p class="price-disclaimer" data-i18n="price_disclaimer">Metal and currency rates are sourced from independent third-party market data providers. Samin's Initiatives does not own, control, or warrant the accuracy of this information. All figures are indicative and intended solely for Zakah estimation purposes.</p>
      </div>

      <!-- API source attribution + FX rates strip -->
      <div class="fx-banner" id="fxBanner" style="display:none;">
        <div class="fx-rates" id="fxRatesStrip"></div>
        <div class="api-sources">
          <span class="source-badge" id="metalSourceBadge">â› Metal Prices</span>
          <span class="source-badge" id="fxSourceBadge">ğŸ’± Exchange Rates (GH Actions)</span>
        </div>
      </div>

      <!-- MANUAL FALLBACK â€” shown only on API failure -->
      <div class="manual-fallback" id="manualFallback">
        <div class="manual-fallback-header">
          âš  <span data-i18n="fallback_header">Live prices unavailable â€” please enter current prices manually</span>
        </div>
        <p class="field-note" style="margin-bottom:10px;" data-i18n="fallback_note">
          You can look up current prices from trusted financial sources. Enter the price per gram in your selected currency below.
        </p>
        <div class="field-group">
          <div class="field">
            <label>ğŸ¥‡ <span data-i18n="gold_price_label">Gold Price / gram (24k)</span></label>
            <div class="input-wrap">
              <span class="input-prefix" id="pfxGold">à§³</span>
              <input type="number" id="goldPriceManual" value="0" min="0" step="0.01" oninput="calc()" />
            </div>
          </div>
          <div class="field">
            <label>ğŸ¥ˆ <span data-i18n="silver_price_label">Silver Price / gram (999)</span></label>
            <div class="input-wrap">
              <span class="input-prefix" id="pfxSilver">à§³</span>
              <input type="number" id="silverPriceManual" value="0" min="0" step="0.01" oninput="calc()" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION A: CASH & LIQUID -->
  <div class="section-card open fade-up" id="sec-cash">
    <div class="section-header" onclick="toggleSection('sec-cash')">
      <div class="section-header-left">
        <div class="section-icon icon-cash">ğŸ’µ</div>
        <div>
          <div class="section-title" data-i18n="sec_cash_title">Section A â€” Cash & Liquid Assets</div>
          <div class="section-subtitle" data-i18n="sec_cash_sub">Physical cash, bank accounts, digital wallets</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-cash">à§³ 0</div>
        <div class="chevron">â–¾</div>
      </div>
    </div>
    <div class="section-body">
      <div class="sub-heading" data-i18n="physical_cash">Physical Cash</div>
      <div class="field-group">
        <div class="field">
          <label><span data-i18n="cash_on_hand">Cash on Hand</span> <span class="tooltip-icon" data-tip="Physical cash you keep at home or in your wallet.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_cashOnHand" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="cash_foreign">Foreign Currency</span> <span class="tooltip-icon" data-tip="Foreign currency you hold, converted to your selected currency.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_cashForeign" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="bank_accounts">Bank Accounts</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="savings_account">Savings Account</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bankSavings" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="current_account">Current / Checking</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bankCurrent" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="fd_savings">FDR / Fixed Deposits</span> <span class="tooltip-icon" data-tip="Principal amount only. Exclude interest (Riba) â€” donate it separately.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bankFD" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>
      <p class="field-note" data-i18n="riba_note">âš  Exclude any accrued interest (Riba) from bank accounts. Interest must be donated separately, not counted as Zakah.</p>

      <!-- DIGITAL WALLETS â€” split into individual entities -->
      <div class="sub-heading" data-i18n="digital_wallets">Digital Wallets</div>
      <div class="field-group triple">
        <div class="field">
          <label>bKash</label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bkash" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Nagad</label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_nagad" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Upay</label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_upay" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Cellfin</label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_cellfin" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Rocket / DBBL</label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_rocket" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>PayPal / Payoneer</label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_paypal" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="others_wallet">Others</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_othersWallet" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="receivables_personal">Personal Receivables</div>
      <div class="field-group">
        <div class="field">
          <label><span data-i18n="money_lent">Money Lent to Others</span> <span class="tooltip-icon" data-tip="Money you've lent that is likely to be returned. Doubtful debts may be excluded.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_moneyLent" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="salary_due">Salary / Bonus Due</span> <span class="tooltip-icon" data-tip="Unpaid salary or bonus owed to you that will be received.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_salaryDue" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION B: PRECIOUS METALS -->
  <div class="section-card fade-up" id="sec-metals">
    <div class="section-header" onclick="toggleSection('sec-metals')">
      <div class="section-header-left">
        <div class="section-icon icon-metals">ğŸ¥‡</div>
        <div>
          <div class="section-title" data-i18n="sec_metals_title">Section B â€” Precious Metals & Jewelry</div>
          <div class="section-subtitle" data-i18n="sec_metals_sub">Gold, silver, bullion, jewelry</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-metals">à§³ 0</div>
        <div class="chevron">â–¾</div>
      </div>
    </div>
    <div class="section-body">
      <div class="info-box gold" data-i18n="jewelry_note">ğŸ“Œ Personal jewelry used regularly (by women) is exempt under Hanafi school. Include gold/silver not worn or kept as savings/investment.</div>

      <div class="sub-heading" data-i18n="gold_heading">Gold</div>
      <div class="field-group triple" style="margin-top:10px;">
        <div class="field">
          <label>Gold 24k (grams)</label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_gold24k" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Gold 22k (grams)</label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_gold22k" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Gold 18k (grams)</label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_gold18k" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Gold 21k (grams)</label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_gold21k" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="gold_coins">Gold Coins / Bars (24k, grams)</span></label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_goldCoins" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
      </div>
      <p class="field-note" data-i18n="karat_formula">Formula used: Weight Ã— (Karat Ã· 24) Ã— Current Gold Price per gram</p>

      <div class="sub-heading" style="margin-top:18px;" data-i18n="silver_heading">Silver</div>
      <div class="field-group" style="margin-top:10px;">
        <div class="field">
          <label><span data-i18n="silver_physical">Silver (grams)</span></label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_silverGrams" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="silver_coins">Silver Coins / Bullion (grams)</span></label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_silverBullion" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
      </div>

      <div id="metalValDisplay" class="nisab-display" style="margin-top:12px;">
        <div class="nisab-stat"><div class="nisab-stat-val" id="goldValTotal">à§³ 0</div><div class="nisab-stat-label" data-i18n="gold_value">Gold Value</div></div>
        <div class="nisab-stat"><div class="nisab-stat-val" id="silverValTotal">à§³ 0</div><div class="nisab-stat-label" data-i18n="silver_value">Silver Value</div></div>
        <div class="nisab-stat"><div class="nisab-stat-val" id="metalValTotalDisp">à§³ 0</div><div class="nisab-stat-label" data-i18n="total_metal_value">Total Metal Value</div></div>
      </div>
    </div>
  </div>

  <!-- SECTION C: INVESTMENTS -->
  <div class="section-card fade-up" id="sec-invest">
    <div class="section-header" onclick="toggleSection('sec-invest')">
      <div class="section-header-left">
        <div class="section-icon icon-invest">ğŸ“ˆ</div>
        <div>
          <div class="section-title" data-i18n="sec_invest_title">Section C â€” Investments & Financial Assets</div>
          <div class="section-subtitle" data-i18n="sec_invest_sub">Stocks, mutual funds, crypto, pension</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-invest">à§³ 0</div>
        <div class="chevron">â–¾</div>
      </div>
    </div>
    <div class="section-body">

      <div class="sub-heading" data-i18n="stocks_heading">Stocks & Shares</div>
      <label style="font-size:12px;color:var(--text-muted);margin-bottom:6px;display:block;" data-i18n="stock_method_label">Calculation Method</label>
      <div class="radio-group" id="stockMethodGroup">
        <label class="radio-btn selected" onclick="selectRadio('stockMethod','trade',this)">
          <input type="radio" name="stockMethod" value="trade" checked />
          <span class="radio-dot"><span></span></span>
          <span data-i18n="method_trade">Short-term Trading (2.5% of market value)</span>
        </label>
        <label class="radio-btn" onclick="selectRadio('stockMethod','longterm',this)">
          <input type="radio" name="stockMethod" value="longterm" />
          <span class="radio-dot"><span></span></span>
          <span data-i18n="method_longterm">Long-term Investment (25% proxy)</span>
        </label>
      </div>
      <div class="info-box" id="stockMethodInfo" data-i18n="method_trade_info">Short-term traders: Pay 2.5% on full portfolio value. Long-term investors: Pay 2.5% on 25% of portfolio (proxy for zakatable assets of the company).</div>

      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="dse_stocks">DSE Stocks (Bangladesh)</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_dseStocks" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="international_stocks">International Stocks</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_intlStocks" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="mutual_funds">Mutual Funds / ETFs</span> <span class="tooltip-icon" data-tip="For Islamic funds, 100% is Zakatable. For conventional funds, use 25% proxy on NAV.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_mutualFunds" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="crypto_heading">Cryptocurrency</div>
      <div class="info-box" data-i18n="crypto_note">Scholars differ on crypto. Most contemporary scholars consider it Zakatable at market value. Include only holdings held for over a lunar year.</div>
      <div class="field-group triple">
        <div class="field">
          <label>Bitcoin (BTC) <span data-i18n="market_val_label">Market Value</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_btc" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label>Ethereum (ETH) <span data-i18n="market_val_label">Market Value</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_eth" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="other_crypto">Other Crypto</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_otherCrypto" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="pension_heading">Provident Fund & Pension</div>
      <div class="info-box" data-i18n="pension_note">Include only the portion you can access. Many scholars say include your own contributions; employer portion upon receipt. Verify with your PF statement.</div>
      <div class="field-group">
        <div class="field">
          <label><span data-i18n="provident_fund">GPF / Provident Fund</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_gpf" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="sanchayapatra">Sanchayapatra / NSC</span> <span class="tooltip-icon" data-tip="Bangladesh National Savings Certificate. Principal amount is Zakatable.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_nsc" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="bonds">Govt Bonds / Sukuk</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bonds" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="other_invest">Other Investment Schemes</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_otherInvest" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION D: BUSINESS ASSETS -->
  <div class="section-card fade-up" id="sec-biz">
    <div class="section-header" onclick="toggleSection('sec-biz')">
      <div class="section-header-left">
        <div class="section-icon icon-biz">ğŸ¢</div>
        <div>
          <div class="section-title" data-i18n="sec_biz_title">Section D â€” Business Assets</div>
          <div class="section-subtitle" data-i18n="sec_biz_sub">Inventory, receivables, business cash</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-biz">à§³ 0</div>
        <div class="chevron">â–¾</div>
      </div>
    </div>
    <div class="section-body">
      <div class="info-box warning" data-i18n="biz_exclude_note">âŒ Exclude: Land, Buildings, Machinery, Vehicles, Office Furniture & Equipment (PPE). These are NOT Zakatable.</div>

      <div class="sub-heading" data-i18n="biz_liquid_heading">Business Liquid Assets</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="biz_cash">Business Cash (in hand)</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bizCash" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="biz_bank">Business Bank Balance</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bizBank" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="petty_cash">Petty Cash / Float</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_pettyCash" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="inventory_heading">Inventory (at Sale Price)</div>
      <div class="info-box" data-i18n="inventory_note">Value inventory at current sale/retail price, NOT cost. Zakah is on the trade value, not what you paid.</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="finished_goods">Finished Goods</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_finishedGoods" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="raw_materials">Raw Materials</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_rawMaterials" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="wip">Work in Progress (WIP)</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_wip" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="trade_goods">Trade Goods / Merchandise</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_tradeGoods" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="receivables_heading">Business Receivables</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="trade_receivables">Trade Receivables</span> <span class="tooltip-icon" data-tip="Money owed to you by clients that you're confident will be paid.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_tradeRec" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="advance_paid">Advances Paid to Suppliers</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_advancePaid" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="security_deposits">Security Deposits Given</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_secDeposit" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION E: LIABILITIES -->
  <div class="section-card fade-up" id="sec-liab">
    <div class="section-header" onclick="toggleSection('sec-liab')">
      <div class="section-header-left">
        <div class="section-icon icon-liab">ğŸ“‰</div>
        <div>
          <div class="section-title" data-i18n="sec_liab_title">Section E â€” Liabilities & Deductions</div>
          <div class="section-subtitle" data-i18n="sec_liab_sub">Short-term debts and payables due within 12 months</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total negative" id="tot-liab">à§³ 0</div>
        <div class="chevron">â–¾</div>
      </div>
    </div>
    <div class="section-body">
      <div class="info-box warning" data-i18n="liab_note">âš  Only deduct debts due within the next 12 months. For long-term loans (mortgage, car loan), deduct only the next 12 months of installments, NOT the remaining principal.</div>

      <div class="sub-heading" data-i18n="personal_debts">Personal Debts</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="personal_loans">Personal Loans Due</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_personalLoan" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="credit_card">Credit Card Balance</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_creditCard" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="mortgage_12mo">Mortgage (next 12 months)</span> <span class="tooltip-icon" data-tip="Only deduct the installment amount due in the next 12 months, not the full remaining balance.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_mortgage12" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="rent_bills">Overdue Rent / Utilities</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_rentBills" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="taxes_due">Taxes Due</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_taxesDue" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="business_liab">Business Liabilities</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="biz_loan">Business Loans (12 months)</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_bizLoan" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="trade_payables">Trade Payables / Supplier Bills</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_tradePayables" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="salaries_payable">Salaries Payable</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_salariesPayable" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="advance_received">Customer Advances Received</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">à§³</span><input type="number" id="f_advanceReceived" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULTS PANEL -->
  <div class="results-panel fade-up" id="resultsPanel">
    <div class="results-header">
      <div>
        <div class="results-title" data-i18n="your_zakah">Your Zakah Summary</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:4px;" data-i18n="hawl_note">Based on one full Hawl (1 year) completion</div>
      </div>
      <div class="results-eligible no" id="eligibleBadge" data-i18n="not_eligible">Not Eligible Yet</div>
    </div>

    <div class="results-grid">
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="total_assets_label">Total Assets</div>
        <div class="result-stat-value gold" id="r_totalAssets">à§³ 0</div>
        <div class="result-stat-sub" data-i18n="before_deductions">before deductions</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="total_liabilities_label">Total Liabilities</div>
        <div class="result-stat-value red" id="r_totalLiab">à§³ 0</div>
        <div class="result-stat-sub" data-i18n="eligible_deductions">eligible deductions</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="net_wealth_label">Net Zakatable Wealth</div>
        <div class="result-stat-value" id="r_netWealth">à§³ 0</div>
        <div class="result-stat-sub" data-i18n="after_deductions">assets âˆ’ liabilities</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="nisab_threshold_label">Nisab Threshold</div>
        <div class="result-stat-value" id="r_nisabVal">à§³ â€”</div>
        <div class="result-stat-sub" id="r_nisabSub">Silver 612.36g</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="zakah_rate_label">Rate Applied</div>
        <div class="result-stat-value" id="r_rateApplied">2.5%</div>
        <div class="result-stat-sub" id="r_rateSub">Lunar (Hijri)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="zakah_due_label">Zakah Due</div>
        <div class="result-stat-value green big" id="r_zakahDue">à§³ 0</div>
        <div class="result-stat-sub" data-i18n="payable_label">Payable this year</div>
      </div>
    </div>

    <!-- NISAB BAR -->
    <div class="nisab-bar-wrap">
      <div class="nisab-bar-label">
        <span data-i18n="wealth_vs_nisab">Your Wealth vs. Nisab</span>
        <span id="nisabPct">0%</span>
      </div>
      <div class="nisab-bar-track">
        <div class="nisab-bar-fill" id="nisabBarFill" style="width:0%"></div>
      </div>
    </div>

    <!-- BREAKDOWN -->
    <div class="breakdown">
      <div class="breakdown-title" data-i18n="detailed_breakdown">Detailed Breakdown</div>
      <div class="breakdown-row">
        <span class="breakdown-row-label" data-i18n="cash_liquid_bd">Cash & Liquid Assets</span>
        <span class="breakdown-row-val pos" id="bd_cash">à§³ 0</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-row-label" data-i18n="precious_metals_bd">Precious Metals</span>
        <span class="breakdown-row-val pos" id="bd_metals">à§³ 0</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-row-label" data-i18n="investments_bd">Investments</span>
        <span class="breakdown-row-val pos" id="bd_invest">à§³ 0</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-row-label" data-i18n="business_bd">Business Assets</span>
        <span class="breakdown-row-val pos" id="bd_biz">à§³ 0</span>
      </div>
      <div class="breakdown-row divider">
        <span class="breakdown-row-label" data-i18n="liabilities_bd">(-) Liabilities</span>
        <span class="breakdown-row-val neg" id="bd_liab">à§³ 0</span>
      </div>
      <div class="breakdown-row divider">
        <span class="breakdown-row-label" data-i18n="net_zakatable">Net Zakatable Wealth</span>
        <span class="breakdown-row-val total" id="bd_net">à§³ 0</span>
      </div>
      <div class="breakdown-row divider">
        <span class="breakdown-row-label" data-i18n="zakah_payable">Zakah Payable</span>
        <span class="breakdown-row-val zakah" id="bd_zakah">à§³ 0</span>
      </div>
    </div>
  </div>

  <div style="display:flex;justify-content:center;margin-bottom:40px;" class="fade-up">
    <button class="btn-reset" onclick="resetAll()">â†º <span data-i18n="reset_btn">Reset All Fields</span></button>
  </div>

</div>
</main>

<!-- PWA INSTALL BANNER -->
<div class="pwa-banner" id="pwaBanner" aria-live="polite" role="complementary" hidden>
  <div class="pwa-banner-inner">
    <div class="pwa-banner-left">
      <div class="pwa-banner-icon">â˜½</div>
      <div class="pwa-banner-text">
        <strong data-i18n="pwa_title">Install Zakah Calculator</strong>
        <span data-i18n="pwa_desc">Add to your home screen for offline access</span>
      </div>
    </div>
    <div class="pwa-banner-actions">
      <button class="pwa-btn-install" id="pwaBtnInstall" data-i18n="pwa_install">Install App</button>
      <button class="pwa-btn-dismiss" id="pwaBtnDismiss" aria-label="Dismiss">âœ•</button>
    </div>
  </div>
  <div class="pwa-ios-hint" id="pwaIosHint" hidden>
    <span data-i18n="pwa_ios_hint">Tap <strong>Share â¬†</strong> then <strong>"Add to Home Screen"</strong></span>
  </div>
</div>

<footer>
  <div class="footer-inner">
    <div class="footer-logo">â˜½ Samin's Initiatives</div>
    <div class="footer-tagline" data-i18n="footer_tagline">Building tools for the Ummah with transparency and trust</div>
    <div class="footer-copy">
      Â© <span id="footerYear"></span> <span>Samin's Initiatives</span> Â· <span data-i18n="designed_by">Designed by</span> <span>Samin Yasar</span>
    </div>
    <div class="footer-links">
      <a href="#" data-i18n="privacy">Privacy Policy</a>
      <a href="#" data-i18n="open_source">Open Source</a>
      <a href="#" data-i18n="contact">Contact</a>
    </div>
    <div style="margin-top:12px;">
      <span class="badge-small">ğŸ”’ <span data-i18n="local_processing">100% Local Processing</span></span>
      &nbsp;
      <span class="badge-small">ğŸŒ <span data-i18n="no_server">No Server Dependency</span></span>
      &nbsp;
      <span class="badge-small">âœ¦ <span data-i18n="open_src_badge">Open Source</span></span>
    </div>
  </div>
</footer>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE LOADER
   Dynamically injects translations/xx.js
   then calls applyLang() once loaded.
   To add a new language:
     1. Create translations/xx.js (copy en.js, translate values, keep keys)
     2. Add <button> in #langToggle
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentLang = localStorage.getItem('zakat_lang') || 'en';
let L = {};   // active translation object â€” populated after script loads

function loadLang(lang, callback) {
  // Remove any previously injected translation script
  const old = document.getElementById('lang-script');
  if (old) old.remove();

  const s = document.createElement('script');
  s.id  = 'lang-script';
  s.src = `translations/${lang}.js`;
  s.onload = () => {
    // Each translation file exposes LANG_DATA on window
    L = window.LANG_DATA || {};
    if (callback) callback();
  };
  s.onerror = () => {
    console.warn(`[i18n] translations/${lang}.js not found, falling back to en`);
    if (lang !== 'en') loadLang('en', callback);
  };
  document.head.appendChild(s);
}

function applyLang(lang) {
  document.documentElement.lang = lang === 'bn' ? 'bn' : 'en';
  document.body.classList.toggle('lang-bn', lang === 'bn');

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (L[key] !== undefined) el.textContent = L[key];
  });
  document.querySelectorAll('[data-i18n-btn]').forEach(el => {
    const key = el.getAttribute('data-i18n-btn');
    if (L[key] !== undefined) el.textContent = L[key];
  });

  // Sync eligible badge text with fresh L
  const nwRaw    = parseFloat(document.getElementById('r_netWealth')?.textContent?.replace(/[^\d.]/g,'') || '0');
  const nisabRaw = parseFloat(document.getElementById('r_nisabVal')?.textContent?.replace(/[^\d.]/g,'')  || '9999999');
  const badge    = document.getElementById('eligibleBadge');
  if (badge) badge.textContent = nwRaw >= nisabRaw ? (L.eligible || 'Zakah Obligatory âœ“') : (L.not_eligible || 'Not Eligible Yet');
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('zakat_lang', lang);
  document.getElementById('btn-en').classList.toggle('active', lang === 'en');
  document.getElementById('btn-bn').classList.toggle('active', lang === 'bn');
  loadLang(lang, () => { applyLang(lang); calc(); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TROY_OZ_TO_GRAM = 31.1035;
const CACHE_TTL_MS    = 24 * 60 * 60 * 1000;
const CURRENCY_SYMBOLS = { BDT:'à§³', USD:'$', SAR:'ï·¼', GBP:'Â£', AUD:'A$', INR:'â‚¹' };
const METALS_URL  = './data/metals.json';
const RATES_URL   = './data/rates.json';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentCurrency = localStorage.getItem('zakat_currency') || 'BDT';
let nisabType       = 'silver';
let calendarType    = 'lunar';
let stockMethod     = 'trade';

let liveGoldUsdPerOz   = 0;
let liveSilverUsdPerOz = 0;
let fxRates            = {};
let pricesLive         = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CACHE HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function cacheWrite(key, data) {
  try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data })); } catch (_) {}
}
function cacheRead(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.ts > CACHE_TTL_MS) return null;
    return obj.data;
  } catch (_) { return null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE PRICE FETCHING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchPrices(isManualRefresh = false) {
  const dot = document.getElementById('liveDot');
  const ts  = document.getElementById('priceTimestamp');
  const btn = document.getElementById('refreshBtn');

  dot.className = 'live-dot loading';
  ts.textContent = L.fetching || 'Fetchingâ€¦';
  btn.disabled = true;
  btn.classList.add('spinning');
  setShimmer(true);

  if (!isManualRefresh) {
    const cached = cacheRead('zakat_metals');
    if (cached) {
      liveGoldUsdPerOz   = cached.gold;
      liveSilverUsdPerOz = cached.silver;
      const fxCached = cacheRead('zakat_fx');
      if (fxCached) {
        fxRates    = fxCached;
        pricesLive = true;
        onPricesReady('cache');
        return;
      }
    }
  }

  try {
    const [ratesRes, metalsRes] = await Promise.allSettled([
      fetch(RATES_URL,  { cache: 'no-cache' }),
      fetch(METALS_URL, { cache: 'no-cache' })
    ]);

    if (ratesRes.status === 'fulfilled' && ratesRes.value.ok) {
      const ratesData = await ratesRes.value.json();
      fxRates = ratesData.rates || ratesData;
    } else {
      throw new Error('rates.json unavailable');
    }

    let metalsOk = false;
    if (metalsRes.status === 'fulfilled' && metalsRes.value.ok) {
      const metalsData = await metalsRes.value.json();
      if (metalsData.gold_usd_per_oz && metalsData.silver_usd_per_oz) {
        liveGoldUsdPerOz   = metalsData.gold_usd_per_oz;
        liveSilverUsdPerOz = metalsData.silver_usd_per_oz;
        metalsOk = true;
      }
    }
    if (!metalsOk) throw new Error('Metal prices unavailable');

    cacheWrite('zakat_fx', fxRates);
    pricesLive = true;
    onPricesReady('live');

  } catch (err) {
    console.warn('Price fetch failed:', err.message);
    const staleMetal = (() => { try { const r = localStorage.getItem('zakat_metals'); return r ? JSON.parse(r).data : null; } catch(_) { return null; } })();
    const staleFx    = (() => { try { const r = localStorage.getItem('zakat_fx');     return r ? JSON.parse(r).data : null; } catch(_) { return null; } })();
    if (staleMetal && staleFx) {
      liveGoldUsdPerOz   = staleMetal.gold;
      liveSilverUsdPerOz = staleMetal.silver;
      fxRates            = staleFx;
      pricesLive         = true;
      onPricesReady('stale');
    } else {
      dot.className  = 'live-dot error';
      ts.textContent = L.price_error || 'Fetch failed â€” using manual input';
      btn.disabled   = false;
      btn.classList.remove('spinning');
      setShimmer(false);
      showFallback();
      calc();
    }
  }
}

function onPricesReady(source) {
  const dot = document.getElementById('liveDot');
  const ts  = document.getElementById('priceTimestamp');
  const btn = document.getElementById('refreshBtn');
  dot.className  = 'live-dot';
  const now = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  const srcLabel = source === 'cache' ? ' (cached)' : source === 'stale' ? ' (stale cache)' : '';
  ts.textContent = `${L.price_updated || 'Updated'}: ${now}${srcLabel}`;
  btn.disabled   = false;
  btn.classList.remove('spinning');
  setShimmer(false);
  hideFallback();
  updatePriceDisplay();
  updateFxBanner();
  calc();
}

function setShimmer(on) {
  ['goldPriceDisplay','silverPriceDisplay','fxRateDisplay'].forEach(id => {
    document.getElementById(id)?.classList.toggle('loading-shimmer', on);
  });
}

function showFallback() {
  document.getElementById('manualFallback').classList.add('visible');
  document.getElementById('fxBanner').style.display = 'none';
  document.getElementById('metalSourceBadge').className = 'source-badge error';
  document.getElementById('fxSourceBadge').className    = 'source-badge error';
}
function hideFallback() {
  document.getElementById('manualFallback').classList.remove('visible');
  document.getElementById('metalSourceBadge').className = 'source-badge active';
  document.getElementById('fxSourceBadge').className    = 'source-badge active';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICE HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getConvertedPrices() {
  if (!pricesLive) {
    return {
      goldPerGram:   parseFloat(document.getElementById('goldPriceManual')?.value   || 0) || 0,
      silverPerGram: parseFloat(document.getElementById('silverPriceManual')?.value || 0) || 0,
    };
  }
  const rate = fxRates[currentCurrency] || 1;
  return {
    goldPerGram:   (liveGoldUsdPerOz   / TROY_OZ_TO_GRAM) * rate,
    silverPerGram: (liveSilverUsdPerOz / TROY_OZ_TO_GRAM) * rate,
  };
}

function updatePriceDisplay() {
  if (!pricesLive) return;
  const { goldPerGram, silverPerGram } = getConvertedPrices();
  const sym  = CURRENCY_SYMBOLS[currentCurrency] || currentCurrency;
  const rate = fxRates[currentCurrency] || 1;

  document.getElementById('goldUsdLabel').textContent   = `$${liveGoldUsdPerOz.toFixed(2)} USD/oz`;
  document.getElementById('silverUsdLabel').textContent = `$${liveSilverUsdPerOz.toFixed(2)} USD/oz`;
  document.getElementById('fxBaseLabel').textContent    = `USD â†’ ${currentCurrency}`;
  document.getElementById('fxRateSub').textContent      = `1 USD = ${sym}${rate.toFixed(4)}`;
  document.getElementById('goldPriceDisplay').textContent   = `${sym} ${goldPerGram.toFixed(2)}`;
  document.getElementById('silverPriceDisplay').textContent = `${sym} ${silverPerGram.toFixed(2)}`;
  document.getElementById('fxRateDisplay').textContent      = `${rate.toFixed(4)}`;
  document.getElementById('goldPerGramSub').textContent   = `per gram (${currentCurrency})`;
  document.getElementById('silverPerGramSub').textContent = `per gram (${currentCurrency})`;
}

function updateFxBanner() {
  if (!pricesLive || !Object.keys(fxRates).length) return;
  const strip  = document.getElementById('fxRatesStrip');
  const banner = document.getElementById('fxBanner');
  const supported = ['BDT','USD','SAR','GBP','AUD','INR'];
  strip.innerHTML = supported.map(cur => {
    const r = fxRates[cur];
    if (!r) return '';
    const sym = CURRENCY_SYMBOLS[cur] || cur;
    return `<div class="fx-rate-item">${cur} <span>${sym}${r.toFixed(2)}</span></div>`;
  }).join('');
  banner.style.display = 'flex';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURRENCY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setCurrency(cur) {
  currentCurrency = cur;
  localStorage.setItem('zakat_currency', cur);
  updateCurrencySymbols();
  updatePriceDisplay();
  updateFxBanner();
  calc();
}

function updateCurrencySymbols() {
  const sym = CURRENCY_SYMBOLS[currentCurrency] || currentCurrency;
  document.querySelectorAll('.curr-pfx').forEach(el => el.textContent = sym);
  const pg = document.getElementById('pfxGold');
  const ps = document.getElementById('pfxSilver');
  if (pg) pg.textContent = sym;
  if (ps) ps.textContent = sym;
}

function fmt(n) {
  const sym = CURRENCY_SYMBOLS[currentCurrency] || currentCurrency;
  if (n === 0) return sym + ' 0';
  return sym + ' ' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS TOGGLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setNisabType(type) {
  nisabType = type;
  document.getElementById('btn-silver').classList.toggle('active', type === 'silver');
  document.getElementById('btn-gold').classList.toggle('active',   type === 'gold');
  calc();
}
function setCalendar(type) {
  calendarType = type;
  document.getElementById('btn-lunar').classList.toggle('active', type === 'lunar');
  document.getElementById('btn-solar').classList.toggle('active', type === 'solar');
  calc();
}
function selectRadio(group, val, labelEl) {
  stockMethod = val;
  document.querySelectorAll('#stockMethodGroup .radio-btn').forEach(b => b.classList.remove('selected'));
  labelEl.classList.add('selected');
  calc();
}
function toggleSection(id) {
  document.getElementById(id).classList.toggle('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CALCULATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function v(id) {
  return parseFloat(document.getElementById(id)?.value || 0) || 0;
}

function calc() {
  const { goldPerGram, silverPerGram } = getConvertedPrices();

  // Section A: Cash
  const cashTotal =
    v('f_cashOnHand') + v('f_cashForeign') +
    v('f_bankSavings') + v('f_bankCurrent') + v('f_bankFD') +
    v('f_bkash')  + v('f_nagad') +
    v('f_upay')   + v('f_cellfin') +
    v('f_rocket') + v('f_paypal') + v('f_othersWallet') +
    v('f_moneyLent') + v('f_salaryDue');

  // Section B: Metals (always in grams)
  const gold24kEquiv =
    v('f_gold24k')   * (24/24) +
    v('f_gold22k')   * (22/24) +
    v('f_gold18k')   * (18/24) +
    v('f_gold21k')   * (21/24) +
    v('f_goldCoins') * 1;

  const goldValue   = gold24kEquiv * goldPerGram;
  const silverGrams = v('f_silverGrams') + v('f_silverBullion');
  const silverValue = silverGrams * silverPerGram;
  const metalTotal  = goldValue + silverValue;

  document.getElementById('goldValTotal').textContent      = fmt(goldValue);
  document.getElementById('silverValTotal').textContent    = fmt(silverValue);
  document.getElementById('metalValTotalDisp').textContent = fmt(metalTotal);

  // Section C: Investments
  const rawStocks = v('f_dseStocks') + v('f_intlStocks');
  const rawMutual = v('f_mutualFunds');
  const stocksVal = stockMethod === 'trade' ? rawStocks : rawStocks * 0.25;
  const mutualVal = stockMethod === 'trade' ? rawMutual : rawMutual * 0.25;
  const cryptoTotal  = v('f_btc') + v('f_eth') + v('f_otherCrypto');
  const pensionTotal = v('f_gpf') + v('f_nsc') + v('f_bonds') + v('f_otherInvest');
  const investTotal  = stocksVal + mutualVal + cryptoTotal + pensionTotal;

  // Section D: Business
  const bizLiquid      = v('f_bizCash') + v('f_bizBank') + v('f_pettyCash');
  const bizInventory   = v('f_finishedGoods') + v('f_rawMaterials') + v('f_wip') + v('f_tradeGoods');
  const bizReceivables = v('f_tradeRec') + v('f_advancePaid') + v('f_secDeposit');
  const bizTotal       = bizLiquid + bizInventory + bizReceivables;

  // Section E: Liabilities
  const personalLiab =
    v('f_personalLoan') + v('f_creditCard') + v('f_mortgage12') +
    v('f_rentBills')    + v('f_taxesDue');
  const bizLiab =
    v('f_bizLoan') + v('f_tradePayables') + v('f_salariesPayable') + v('f_advanceReceived');
  const liabTotal = personalLiab + bizLiab;

  // Totals
  const totalAssets = cashTotal + metalTotal + investTotal + bizTotal;
  const netWealth   = Math.max(0, totalAssets - liabTotal);

  // Nisab
  const SILVER_NISAB_G = 612.36;
  const GOLD_NISAB_G   = 87.48;
  const nisabValue = nisabType === 'silver'
    ? SILVER_NISAB_G * silverPerGram
    : GOLD_NISAB_G   * goldPerGram;

  const metalLabel = nisabType === 'silver' ? '612.36g Silver' : '87.48g Gold';
  document.getElementById('nisabMetalDisp').textContent = metalLabel;
  document.getElementById('nisabValueDisp').textContent = fmt(nisabValue);

  // Zakah rate
  const zakahRate     = calendarType === 'lunar' ? 0.025 : 0.02577;
  const rateLabel     = calendarType === 'lunar' ? '2.5%' : '2.577%';
  const calendarLabel = calendarType === 'lunar' ? 'Lunar (Hijri)' : 'Solar (Gregorian)';
  document.getElementById('zakahRateDisp').textContent = rateLabel;

  // Eligibility
  const isEligible = nisabValue > 0 && netWealth >= nisabValue;
  const zakahDue   = isEligible ? netWealth * zakahRate : 0;

  // Progress bar
  const fieldIds = [
    'f_cashOnHand','f_cashForeign','f_bankSavings','f_bankCurrent','f_bankFD',
    'f_bkash','f_nagad','f_upay','f_cellfin','f_rocket','f_paypal','f_othersWallet',
    'f_moneyLent','f_salaryDue',
    'f_gold24k','f_gold22k','f_gold18k','f_gold21k','f_goldCoins',
    'f_silverGrams','f_silverBullion',
    'f_dseStocks','f_intlStocks','f_mutualFunds','f_btc','f_eth','f_otherCrypto',
    'f_gpf','f_nsc','f_bonds','f_otherInvest',
    'f_bizCash','f_bizBank','f_pettyCash',
    'f_finishedGoods','f_rawMaterials','f_wip','f_tradeGoods',
    'f_tradeRec','f_advancePaid','f_secDeposit',
    'f_personalLoan','f_creditCard','f_mortgage12','f_rentBills','f_taxesDue',
    'f_bizLoan','f_tradePayables','f_salariesPayable','f_advanceReceived'
  ];
  const filledCount = fieldIds.filter(id => v(id) > 0).length;
  document.getElementById('progressFill').style.width = Math.min(100, Math.round(filledCount / fieldIds.length * 100)) + '%';

  // Section totals
  document.getElementById('tot-cash').textContent   = fmt(cashTotal);
  document.getElementById('tot-metals').textContent = fmt(metalTotal);
  document.getElementById('tot-invest').textContent = fmt(investTotal);
  document.getElementById('tot-biz').textContent    = fmt(bizTotal);
  document.getElementById('tot-liab').textContent   = fmt(liabTotal);

  // Results panel
  document.getElementById('r_totalAssets').textContent = fmt(totalAssets);
  document.getElementById('r_totalLiab').textContent   = fmt(liabTotal);
  document.getElementById('r_netWealth').textContent   = fmt(netWealth);
  document.getElementById('r_nisabVal').textContent    = fmt(nisabValue);
  document.getElementById('r_nisabSub').textContent    = metalLabel;
  document.getElementById('r_rateApplied').textContent = rateLabel;
  document.getElementById('r_rateSub').textContent     = calendarLabel;
  document.getElementById('r_zakahDue').textContent    = fmt(zakahDue);

  const pct = nisabValue > 0 ? Math.min(100, (netWealth / nisabValue) * 100) : 0;
  document.getElementById('nisabBarFill').style.width = pct + '%';
  document.getElementById('nisabPct').textContent     = pct.toFixed(1) + '%';

  const badge = document.getElementById('eligibleBadge');
  badge.textContent = isEligible ? (L.eligible || 'Zakah Obligatory âœ“') : (L.not_eligible || 'Not Eligible Yet');
  badge.className   = 'results-eligible ' + (isEligible ? 'yes' : 'no');
  document.getElementById('r_netWealth').className = 'result-stat-value ' + (isEligible ? 'green' : '');

  // Breakdown
  document.getElementById('bd_cash').textContent   = fmt(cashTotal);
  document.getElementById('bd_metals').textContent = fmt(metalTotal);
  document.getElementById('bd_invest').textContent = fmt(investTotal);
  document.getElementById('bd_biz').textContent    = fmt(bizTotal);
  document.getElementById('bd_liab').textContent   = fmt(liabTotal);
  document.getElementById('bd_net').textContent    = fmt(netWealth);
  document.getElementById('bd_zakah').textContent  = fmt(zakahDue);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function resetAll() {
  document.querySelectorAll('input[type="number"]').forEach(inp => inp.value = 0);
  calc();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA â€” Service Worker & Install Prompt
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg  => console.info('[SW] Registered, scope:', reg.scope))
      .catch(err => console.warn('[SW] Registration failed:', err));
  });
}

let deferredPrompt = null;
const banner     = document.getElementById('pwaBanner');
const btnInstall = document.getElementById('pwaBtnInstall');
const btnDismiss = document.getElementById('pwaBtnDismiss');
const iosHint    = document.getElementById('pwaIosHint');

const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent) &&
              /safari/i.test(navigator.userAgent) &&
              !('standalone' in navigator && navigator.standalone);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                     navigator.standalone === true;

function wasDismissed() {
  const ts = parseInt(localStorage.getItem('pwa_dismissed') || '0', 10);
  return ts && (Date.now() - ts) < 30 * 24 * 60 * 60 * 1000;
}
function showBanner() { if (isStandalone || wasDismissed()) return; banner.hidden = false; if (isIos) iosHint.hidden = false; }
function hideBanner()  { banner.hidden = true; }

window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; setTimeout(showBanner, 3000); });
btnInstall?.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') hideBanner();
    deferredPrompt = null;
  }
});
btnDismiss?.addEventListener('click', () => { localStorage.setItem('pwa_dismissed', String(Date.now())); hideBanner(); });
if (isIos && !isStandalone) { setTimeout(showBanner, 3500); if (btnInstall) btnInstall.hidden = true; }
window.addEventListener('appinstalled', () => { hideBanner(); deferredPrompt = null; });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
  const savedCur = localStorage.getItem('zakat_currency') || 'BDT';
  document.getElementById('currencySelect').value = savedCur;
  currentCurrency = savedCur;
  updateCurrencySymbols();

  document.getElementById('footerYear').textContent = new Date().getFullYear();

  // Set lang toggle button state
  document.getElementById('btn-en').classList.toggle('active', currentLang === 'en');
  document.getElementById('btn-bn').classList.toggle('active', currentLang === 'bn');

  // Load translation first, then initialise everything
  loadLang(currentLang, () => {
    applyLang(currentLang);
    calc();
    fetchPrices();
  });
});
</script>

<!-- One small style addition for the price disclaimer text -->
<style>
.price-disclaimer {
  font-size: 11px;
  color: var(--text-muted, #888);
  line-height: 1.5;
  margin: 12px 4px 0;
  padding: 8px 10px;
  border-top: 1px solid var(--border, #e5e5e5);
  opacity: 0.85;
}
</style>
</body>
</html>
