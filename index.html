<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Zakah Calculator ‚Äî Samin's Initiatives</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json" />

<!-- Theme & status bar colours -->
<meta name="theme-color" content="#c9a84c" />
<meta name="msapplication-navbutton-color" content="#c9a84c" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zakah Calc" />
<link rel="apple-touch-icon" href="icons/icon-192x192.png" />
<link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png" />
<link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png" />

<!-- Android / general -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="application-name" content="Zakah Calc" />
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32"   href="icons/icon-128x128.png" />

<!-- SEO / Social -->
<meta name="description" content="A comprehensive, scholarly-accurate Zakah calculator covering cash, metals, investments, and business assets. 100% private ‚Äî all processing happens locally in your browser." />
<meta name="robots" content="index, follow" />
<meta property="og:title"       content="Zakah Calculator ‚Äî Samin's Initiatives" />
<meta property="og:description" content="Calculate your Zakah accurately with live metal prices and multi-currency support." />
<meta property="og:type"        content="website" />

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&family=Noto+Serif+Bengali:wght@300;400;500;600;700&display=swap" />
<link rel="stylesheet" href="styles.css" />

<!-- jsPDF ‚Äî loaded early so it's ready when user clicks Export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo-block">
      <div class="logo-icon">‚òΩ</div>
      <div class="logo-text">
        <h1 data-i18n="title">Zakah Calculator</h1>
        <p data-i18n="brand">Samin's Initiatives</p>
      </div>
    </div>
    <div class="header-controls">
      <div class="pill-toggle" id="langToggle">
        <button onclick="setLang('en')" id="btn-en" class="active">EN</button>
        <button onclick="setLang('bn')" id="btn-bn">‡¶¨‡¶æ‡¶Ç</button>
      </div>
      <select class="currency-select" id="currencySelect" onchange="setCurrency(this.value)">
        <option value="BDT">‡ß≥ BDT</option>
        <option value="USD">$ USD</option>
        <option value="SAR">Ô∑º SAR</option>
        <option value="GBP">¬£ GBP</option>
        <option value="AUD">A$ AUD</option>
        <option value="INR">‚Çπ INR</option>
      </select>
      <!-- Share button -->
      <button class="btn-icon-header" id="shareBtn" onclick="openShareModal()" title="Share">
        ‚Üë
      </button>
    </div>
  </div>
</header>

<main>
<div class="wrap">

  <!-- HERO -->
  <div class="hero fade-up">
    <div class="hero-badge">‚ú¶ <span data-i18n="badge">2026 Professional Zakah Calculator</span></div>
    <h2 data-i18n="hero_title">Calculate Your Zakah with Precision</h2>
    <p data-i18n="hero_desc">A comprehensive, scholarly-accurate calculator covering all asset categories including digital wallets, investments, and business assets.</p>
    <div class="security-banner">
      üîí <span data-i18n="security_note">100% Secure &amp; Open-Source ‚Äî All data processed locally in your browser. No server. No data shared.</span>
    </div>
  </div>

  <!-- QURAN -->
  <div class="quran-banner fade-up">
    <div class="quran-arabic">ŸàŸéÿ£ŸéŸÇŸêŸäŸÖŸèŸàÿß ÿßŸÑÿµŸéŸëŸÑŸéÿßÿ©Ÿé ŸàŸéÿ¢ÿ™ŸèŸàÿß ÿßŸÑÿ≤ŸéŸëŸÉŸéÿßÿ©Ÿé</div>
    <div class="quran-trans" data-i18n="quran_trans">"Establish prayer and give Zakah." ‚Äî Quran 2:43</div>
  </div>

  <!-- PROGRESS -->
  <div class="progress-bar fade-up">
    <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
  </div>

  <!-- SETTINGS -->
  <div class="settings-card fade-up">
    <div class="settings-card-title">‚öô <span data-i18n="calc_settings">Calculation Settings</span></div>
    <div class="settings-row">
      <div class="setting-group">
        <label data-i18n="nisab_based_on">Nisab Based On</label>
        <div class="pill-toggle" style="width:100%; justify-content:center;">
          <button onclick="setNisabType('silver')" id="btn-silver" class="active" data-i18n-btn="silver_nisab">Silver (Recommended)</button>
          <button onclick="setNisabType('gold')"   id="btn-gold"   data-i18n-btn="gold_nisab">Gold</button>
        </div>
      </div>
      <div class="setting-group">
        <label data-i18n="calendar_type">Calendar Type</label>
        <div class="pill-toggle" style="width:100%; justify-content:center;">
          <button onclick="setCalendar('lunar')" id="btn-lunar" class="active" data-i18n-btn="lunar">Lunar (2.5%)</button>
          <button onclick="setCalendar('solar')" id="btn-solar" data-i18n-btn="solar">Solar (2.577%)</button>
        </div>
      </div>
    </div>
    <div class="nisab-display" id="nisabDisplay">
      <div class="nisab-stat">
        <div class="nisab-stat-val" id="nisabMetalDisp">612.36g Silver</div>
        <div class="nisab-stat-label" data-i18n="nisab_weight">Nisab Weight</div>
      </div>
      <div class="nisab-stat">
        <div class="nisab-stat-val" id="nisabValueDisp">‚Äî</div>
        <div class="nisab-stat-label" data-i18n="nisab_value">Nisab Value</div>
      </div>
      <div class="nisab-stat">
        <div class="nisab-stat-val" id="zakahRateDisp">2.5%</div>
        <div class="nisab-stat-label" data-i18n="zakah_rate">Zakah Rate</div>
      </div>
    </div>

    <!-- LIVE PRICE PANEL -->
    <div style="margin-top:16px;">
      <div class="price-panel">
        <div class="price-panel-header">
          <div class="price-panel-title">
            <span class="live-dot loading" id="liveDot"></span>
            <span data-i18n="live_prices_title">Live Metal Prices</span>
          </div>
          <div class="price-meta">
            <span class="price-timestamp" id="priceTimestamp" data-i18n="fetching">Fetching‚Ä¶</span>
            <button class="btn-refresh" id="refreshBtn" onclick="fetchPrices(true)" disabled>
              <span class="spin">‚Ü∫</span> <span data-i18n="refresh">Refresh</span>
            </button>
          </div>
        </div>
        <div class="price-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="price-cell">
            <div class="price-cell-label">ü•á <span data-i18n="gold_24k_label">Gold 24k</span></div>
            <div class="price-cell-usd" id="goldUsdLabel">‚Äî USD/oz</div>
            <div class="price-cell-val loading-shimmer" id="goldPriceDisplay">Loading‚Ä¶</div>
            <div class="price-cell-sub" id="goldPerGramSub">per gram</div>
          </div>
          <div class="price-cell">
            <div class="price-cell-label">ü•à <span data-i18n="silver_999_label">Silver 999</span></div>
            <div class="price-cell-usd" id="silverUsdLabel">‚Äî USD/oz</div>
            <div class="price-cell-val loading-shimmer" id="silverPriceDisplay">Loading‚Ä¶</div>
            <div class="price-cell-sub" id="silverPerGramSub">per gram</div>
          </div>
          <div class="price-cell">
            <div class="price-cell-label">üí± <span data-i18n="fx_rate_label">Exchange Rate</span></div>
            <div class="price-cell-usd" id="fxBaseLabel">USD base</div>
            <div class="price-cell-val loading-shimmer" id="fxRateDisplay">Loading‚Ä¶</div>
            <div class="price-cell-sub" id="fxRateSub">1 USD = ?</div>
          </div>
        </div>
        <p class="price-disclaimer" data-i18n="price_disclaimer">Metal and currency rates are sourced from independent third-party market data providers. Samin's Initiatives does not own, control, or warrant the accuracy of this information. All figures are indicative and intended solely for Zakah estimation purposes.</p>
      </div>

      <div class="fx-banner" id="fxBanner" style="display:none;">
        <div class="fx-rates" id="fxRatesStrip"></div>
        <div class="api-sources">
          <span class="source-badge" id="metalSourceBadge">‚õè Metal Prices</span>
          <span class="source-badge" id="fxSourceBadge">üí± Exchange Rates (GH Actions)</span>
        </div>
      </div>

      <div class="manual-fallback" id="manualFallback">
        <div class="manual-fallback-header">
          ‚ö† <span data-i18n="fallback_header">Live prices unavailable ‚Äî please enter current prices manually</span>
        </div>
        <p class="field-note" style="margin-bottom:10px;" data-i18n="fallback_note">
          You can look up current prices from trusted financial sources. Enter the price per gram in your selected currency below.
        </p>
        <div class="field-group">
          <div class="field">
            <label>ü•á <span data-i18n="gold_price_label">Gold Price / gram (24k)</span></label>
            <div class="input-wrap">
              <span class="input-prefix" id="pfxGold">‡ß≥</span>
              <input type="number" id="goldPriceManual" value="0" min="0" step="0.01" oninput="calc()" />
            </div>
          </div>
          <div class="field">
            <label>ü•à <span data-i18n="silver_price_label">Silver Price / gram (999)</span></label>
            <div class="input-wrap">
              <span class="input-prefix" id="pfxSilver">‡ß≥</span>
              <input type="number" id="silverPriceManual" value="0" min="0" step="0.01" oninput="calc()" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION A: CASH & LIQUID -->
  <div class="section-card open fade-up" id="sec-cash">
    <div class="section-header" onclick="toggleSection('sec-cash')">
      <div class="section-header-left">
        <div class="section-icon icon-cash">üíµ</div>
        <div>
          <div class="section-title" data-i18n="sec_cash_title">Section A ‚Äî Cash &amp; Liquid Assets</div>
          <div class="section-subtitle" data-i18n="sec_cash_sub">Physical cash, bank accounts, digital wallets</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-cash">‡ß≥ 0</div>
        <div class="chevron">‚ñæ</div>
      </div>
    </div>
    <div class="section-body">
      <div class="sub-heading" data-i18n="physical_cash">Physical Cash</div>
      <div class="field-group">
        <div class="field">
          <label><span data-i18n="cash_on_hand">Cash on Hand</span> <span class="tooltip-icon" data-tip-key="tip_cash_on_hand" data-tip="Physical cash you keep at home or in your wallet.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_cashOnHand" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="cash_foreign">Foreign Currency</span> <span class="tooltip-icon" data-tip-key="tip_cash_foreign" data-tip="Foreign currency you hold, converted to your selected currency.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_cashForeign" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="bank_accounts">Bank Accounts</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="savings_account">Savings Account</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bankSavings" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="current_account">Current / Checking</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bankCurrent" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="fd_savings">FDR / Fixed Deposits</span> <span class="tooltip-icon" data-tip-key="tip_fdr" data-tip="Principal amount only. Exclude interest (Riba) ‚Äî donate it separately.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bankFD" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>
      <p class="field-note" data-i18n="riba_note">‚ö† Exclude any accrued interest (Riba) from bank accounts. Interest must be donated separately, not counted as Zakah.</p>

      <div class="sub-heading" data-i18n="digital_wallets">Digital Wallets</div>
      <div class="field-group triple">
        <div class="field"><label>bKash</label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bkash"   value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label>Nagad</label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_nagad"   value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label>Upay</label> <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_upay"    value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label>Cellfin</label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_cellfin" value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label>Rocket / DBBL</label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_rocket"  value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label>PayPal / Payoneer</label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_paypal"  value="0" min="0" oninput="calc()" /></div></div>
        <div class="field">
          <label><span data-i18n="others_wallet">Others</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_othersWallet" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="receivables_personal">Personal Receivables</div>
      <div class="field-group">
        <div class="field">
          <label><span data-i18n="money_lent">Money Lent to Others</span> <span class="tooltip-icon" data-tip-key="tip_money_lent" data-tip="Money you've lent that is likely to be returned. Doubtful debts may be excluded.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_moneyLent" value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="salary_due">Salary / Bonus Due</span> <span class="tooltip-icon" data-tip-key="tip_salary_due" data-tip="Unpaid salary or bonus owed to you that will be received.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_salaryDue" value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION B: PRECIOUS METALS -->
  <div class="section-card fade-up" id="sec-metals">
    <div class="section-header" onclick="toggleSection('sec-metals')">
      <div class="section-header-left">
        <div class="section-icon icon-metals">ü•á</div>
        <div>
          <div class="section-title" data-i18n="sec_metals_title">Section B ‚Äî Precious Metals &amp; Jewelry</div>
          <div class="section-subtitle" data-i18n="sec_metals_sub">Gold, silver, bullion, jewelry</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-metals">‡ß≥ 0</div>
        <div class="chevron">‚ñæ</div>
      </div>
    </div>
    <div class="section-body">
      <div class="info-box gold" data-i18n="jewelry_note">üìå Personal jewelry used regularly (by women) is exempt under Hanafi school. Include gold/silver not worn or kept as savings/investment.</div>

      <div class="sub-heading" data-i18n="gold_heading">Gold</div>
      <div class="field-group triple" style="margin-top:10px;">
        <div class="field"><label>Gold 24k (grams)</label><div class="input-wrap"><input type="number" class="no-prefix" id="f_gold24k"   value="0" min="0" step="0.001" oninput="calc()" /></div></div>
        <div class="field"><label>Gold 22k (grams)</label><div class="input-wrap"><input type="number" class="no-prefix" id="f_gold22k"   value="0" min="0" step="0.001" oninput="calc()" /></div></div>
        <div class="field"><label>Gold 18k (grams)</label><div class="input-wrap"><input type="number" class="no-prefix" id="f_gold18k"   value="0" min="0" step="0.001" oninput="calc()" /></div></div>
        <div class="field"><label>Gold 21k (grams)</label><div class="input-wrap"><input type="number" class="no-prefix" id="f_gold21k"   value="0" min="0" step="0.001" oninput="calc()" /></div></div>
        <div class="field">
          <label><span data-i18n="gold_coins">Gold Coins / Bars (24k, grams)</span></label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_goldCoins" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
      </div>
      <p class="field-note" data-i18n="karat_formula">Formula used: Weight √ó (Karat √∑ 24) √ó Current Gold Price per gram</p>

      <div class="sub-heading" style="margin-top:18px;" data-i18n="silver_heading">Silver</div>
      <div class="field-group" style="margin-top:10px;">
        <div class="field">
          <label><span data-i18n="silver_physical">Silver (grams)</span></label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_silverGrams"   value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
        <div class="field">
          <label><span data-i18n="silver_coins">Silver Coins / Bullion (grams)</span></label>
          <div class="input-wrap"><input type="number" class="no-prefix" id="f_silverBullion" value="0" min="0" step="0.001" oninput="calc()" /></div>
        </div>
      </div>

      <div id="metalValDisplay" class="nisab-display" style="margin-top:12px;">
        <div class="nisab-stat"><div class="nisab-stat-val" id="goldValTotal">‡ß≥ 0</div><div class="nisab-stat-label" data-i18n="gold_value">Gold Value</div></div>
        <div class="nisab-stat"><div class="nisab-stat-val" id="silverValTotal">‡ß≥ 0</div><div class="nisab-stat-label" data-i18n="silver_value">Silver Value</div></div>
        <div class="nisab-stat"><div class="nisab-stat-val" id="metalValTotalDisp">‡ß≥ 0</div><div class="nisab-stat-label" data-i18n="total_metal_value">Total Metal Value</div></div>
      </div>
    </div>
  </div>

  <!-- SECTION C: INVESTMENTS -->
  <div class="section-card fade-up" id="sec-invest">
    <div class="section-header" onclick="toggleSection('sec-invest')">
      <div class="section-header-left">
        <div class="section-icon icon-invest">üìà</div>
        <div>
          <div class="section-title" data-i18n="sec_invest_title">Section C ‚Äî Investments &amp; Financial Assets</div>
          <div class="section-subtitle" data-i18n="sec_invest_sub">Stocks, mutual funds, crypto, pension</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-invest">‡ß≥ 0</div>
        <div class="chevron">‚ñæ</div>
      </div>
    </div>
    <div class="section-body">
      <div class="sub-heading" data-i18n="stocks_heading">Stocks &amp; Shares</div>
      <label style="font-size:12px;color:var(--text-muted);margin-bottom:6px;display:block;" data-i18n="stock_method_label">Calculation Method</label>
      <div class="radio-group" id="stockMethodGroup">
        <label class="radio-btn selected" onclick="selectRadio('stockMethod','trade',this)">
          <input type="radio" name="stockMethod" value="trade" checked />
          <span class="radio-dot"><span></span></span>
          <span data-i18n="method_trade">Short-term Trading (2.5% of market value)</span>
        </label>
        <label class="radio-btn" onclick="selectRadio('stockMethod','longterm',this)">
          <input type="radio" name="stockMethod" value="longterm" />
          <span class="radio-dot"><span></span></span>
          <span data-i18n="method_longterm">Long-term Investment (25% proxy)</span>
        </label>
      </div>
      <div class="info-box" id="stockMethodInfo" data-i18n="method_trade_info">Short-term traders: Pay 2.5% on full portfolio value. Long-term investors: Pay 2.5% on 25% of portfolio (proxy for zakatable assets of the company).</div>

      <div class="field-group triple">
        <div class="field"><label><span data-i18n="dse_stocks">DSE Stocks (Bangladesh)</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_dseStocks"   value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="international_stocks">International Stocks</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_intlStocks"  value="0" min="0" oninput="calc()" /></div></div>
        <div class="field">
          <label><span data-i18n="mutual_funds">Mutual Funds / ETFs</span> <span class="tooltip-icon" data-tip-key="tip_mutual_funds" data-tip="For Islamic funds, 100% is Zakatable. For conventional funds, use 25% proxy on NAV.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_mutualFunds"  value="0" min="0" oninput="calc()" /></div>
        </div>
      </div>

      <div class="sub-heading" data-i18n="crypto_heading">Cryptocurrency</div>
      <div class="info-box" data-i18n="crypto_note">Scholars differ on crypto. Most contemporary scholars consider it Zakatable at market value. Include only holdings held for over a lunar year.</div>
      <div class="field-group triple">
        <div class="field"><label>Bitcoin (BTC) <span data-i18n="market_val_label">Market Value</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_btc"          value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label>Ethereum (ETH) <span data-i18n="market_val_label">Market Value</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_eth"          value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="other_crypto">Other Crypto</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_otherCrypto"  value="0" min="0" oninput="calc()" /></div></div>
      </div>

      <div class="sub-heading" data-i18n="pension_heading">Provident Fund &amp; Pension</div>
      <div class="info-box" data-i18n="pension_note">Include only the portion you can access. Many scholars say include your own contributions; employer portion upon receipt. Verify with your PF statement.</div>
      <div class="field-group">
        <div class="field"><label><span data-i18n="provident_fund">GPF / Provident Fund</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_gpf"          value="0" min="0" oninput="calc()" /></div></div>
        <div class="field">
          <label><span data-i18n="sanchayapatra">Sanchayapatra / NSC</span> <span class="tooltip-icon" data-tip-key="tip_nsc" data-tip="Bangladesh National Savings Certificate. Principal amount is Zakatable.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_nsc"          value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field"><label><span data-i18n="bonds">Govt Bonds / Sukuk</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bonds"        value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="other_invest">Other Investment Schemes</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_otherInvest"  value="0" min="0" oninput="calc()" /></div></div>
      </div>
    </div>
  </div>

  <!-- SECTION D: BUSINESS ASSETS -->
  <div class="section-card fade-up" id="sec-biz">
    <div class="section-header" onclick="toggleSection('sec-biz')">
      <div class="section-header-left">
        <div class="section-icon icon-biz">üè¢</div>
        <div>
          <div class="section-title" data-i18n="sec_biz_title">Section D ‚Äî Business Assets</div>
          <div class="section-subtitle" data-i18n="sec_biz_sub">Inventory, receivables, business cash</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total" id="tot-biz">‡ß≥ 0</div>
        <div class="chevron">‚ñæ</div>
      </div>
    </div>
    <div class="section-body">
      <div class="info-box warning" data-i18n="biz_exclude_note">‚ùå Exclude: Land, Buildings, Machinery, Vehicles, Office Furniture &amp; Equipment (PPE). These are NOT Zakatable.</div>

      <div class="sub-heading" data-i18n="biz_liquid_heading">Business Liquid Assets</div>
      <div class="field-group triple">
        <div class="field"><label><span data-i18n="biz_cash">Business Cash (in hand)</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bizCash"      value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="biz_bank">Business Bank Balance</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bizBank"      value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="petty_cash">Petty Cash / Float</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_pettyCash"    value="0" min="0" oninput="calc()" /></div></div>
      </div>

      <div class="sub-heading" data-i18n="inventory_heading">Inventory (at Sale Price)</div>
      <div class="info-box" data-i18n="inventory_note">Value inventory at current sale/retail price, NOT cost. Zakah is on the trade value, not what you paid.</div>
      <div class="field-group triple">
        <div class="field"><label><span data-i18n="finished_goods">Finished Goods</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_finishedGoods" value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="raw_materials">Raw Materials</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_rawMaterials"  value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="wip">Work in Progress (WIP)</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_wip"           value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="trade_goods">Trade Goods / Merchandise</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_tradeGoods"    value="0" min="0" oninput="calc()" /></div></div>
      </div>

      <div class="sub-heading" data-i18n="receivables_heading">Business Receivables</div>
      <div class="field-group triple">
        <div class="field">
          <label><span data-i18n="trade_receivables">Trade Receivables</span> <span class="tooltip-icon" data-tip-key="tip_trade_rec" data-tip="Money owed to you by clients that you're confident will be paid.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_tradeRec"      value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field"><label><span data-i18n="advance_paid">Advances Paid to Suppliers</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_advancePaid"   value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="security_deposits">Security Deposits Given</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_secDeposit"    value="0" min="0" oninput="calc()" /></div></div>
      </div>
    </div>
  </div>

  <!-- SECTION E: LIABILITIES -->
  <div class="section-card fade-up" id="sec-liab">
    <div class="section-header" onclick="toggleSection('sec-liab')">
      <div class="section-header-left">
        <div class="section-icon icon-liab">üìâ</div>
        <div>
          <div class="section-title" data-i18n="sec_liab_title">Section E ‚Äî Liabilities &amp; Deductions</div>
          <div class="section-subtitle" data-i18n="sec_liab_sub">Short-term debts and payables due within 12 months</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="section-total negative" id="tot-liab">‡ß≥ 0</div>
        <div class="chevron">‚ñæ</div>
      </div>
    </div>
    <div class="section-body">
      <div class="info-box warning" data-i18n="liab_note">‚ö† Only deduct debts due within the next 12 months. For long-term loans (mortgage, car loan), deduct only the next 12 months of installments, NOT the remaining principal.</div>

      <div class="sub-heading" data-i18n="personal_debts">Personal Debts</div>
      <div class="field-group triple">
        <div class="field"><label><span data-i18n="personal_loans">Personal Loans Due</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_personalLoan"    value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="credit_card">Credit Card Balance</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_creditCard"       value="0" min="0" oninput="calc()" /></div></div>
        <div class="field">
          <label><span data-i18n="mortgage_12mo">Mortgage (next 12 months)</span> <span class="tooltip-icon" data-tip-key="tip_mortgage" data-tip="Only deduct the installment amount due in the next 12 months, not the full remaining balance.">?</span></label>
          <div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_mortgage12"      value="0" min="0" oninput="calc()" /></div>
        </div>
        <div class="field"><label><span data-i18n="rent_bills">Overdue Rent / Utilities</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_rentBills"       value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="taxes_due">Taxes Due</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_taxesDue"        value="0" min="0" oninput="calc()" /></div></div>
      </div>

      <div class="sub-heading" data-i18n="business_liab">Business Liabilities</div>
      <div class="field-group triple">
        <div class="field"><label><span data-i18n="biz_loan">Business Loans (12 months)</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_bizLoan"         value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="trade_payables">Trade Payables / Supplier Bills</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_tradePayables"  value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="salaries_payable">Salaries Payable</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_salariesPayable" value="0" min="0" oninput="calc()" /></div></div>
        <div class="field"><label><span data-i18n="advance_received">Customer Advances Received</span></label><div class="input-wrap"><span class="input-prefix curr-pfx">‡ß≥</span><input type="number" id="f_advanceReceived" value="0" min="0" oninput="calc()" /></div></div>
      </div>
    </div>
  </div>

  <!-- RESULTS PANEL -->
  <div class="results-panel fade-up" id="resultsPanel">
    <div class="results-header">
      <div>
        <div class="results-title" data-i18n="your_zakah">Your Zakah Summary</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:4px;" data-i18n="hawl_note">Based on one full Hawl (1 year) completion</div>
      </div>
      <div class="results-eligible no" id="eligibleBadge" data-i18n="not_eligible">Not Eligible Yet</div>
    </div>

    <div class="results-grid">
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="total_assets_label">Total Assets</div>
        <div class="result-stat-value gold" id="r_totalAssets">‡ß≥ 0</div>
        <div class="result-stat-sub" data-i18n="before_deductions">before deductions</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="total_liabilities_label">Total Liabilities</div>
        <div class="result-stat-value red" id="r_totalLiab">‡ß≥ 0</div>
        <div class="result-stat-sub" data-i18n="eligible_deductions">eligible deductions</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="net_wealth_label">Net Zakatable Wealth</div>
        <div class="result-stat-value" id="r_netWealth">‡ß≥ 0</div>
        <div class="result-stat-sub" data-i18n="after_deductions">assets ‚àí liabilities</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="nisab_threshold_label">Nisab Threshold</div>
        <div class="result-stat-value" id="r_nisabVal">‡ß≥ ‚Äî</div>
        <div class="result-stat-sub" id="r_nisabSub">Silver 612.36g</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="zakah_rate_label">Rate Applied</div>
        <div class="result-stat-value" id="r_rateApplied">2.5%</div>
        <div class="result-stat-sub" id="r_rateSub">Lunar (Hijri)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-label" data-i18n="zakah_due_label">Zakah Due</div>
        <div class="result-stat-value green big" id="r_zakahDue">‡ß≥ 0</div>
        <div class="result-stat-sub" data-i18n="payable_label">Payable this year</div>
      </div>
    </div>

    <div class="nisab-bar-wrap">
      <div class="nisab-bar-label">
        <span data-i18n="wealth_vs_nisab">Your Wealth vs. Nisab</span>
        <span id="nisabPct">0%</span>
      </div>
      <div class="nisab-bar-track">
        <div class="nisab-bar-fill" id="nisabBarFill" style="width:0%"></div>
      </div>
    </div>

    <div class="breakdown">
      <div class="breakdown-title" data-i18n="detailed_breakdown">Detailed Breakdown</div>
      <div class="breakdown-row"><span class="breakdown-row-label" data-i18n="cash_liquid_bd">Cash &amp; Liquid Assets</span><span class="breakdown-row-val pos" id="bd_cash">‡ß≥ 0</span></div>
      <div class="breakdown-row"><span class="breakdown-row-label" data-i18n="precious_metals_bd">Precious Metals</span><span class="breakdown-row-val pos" id="bd_metals">‡ß≥ 0</span></div>
      <div class="breakdown-row"><span class="breakdown-row-label" data-i18n="investments_bd">Investments</span><span class="breakdown-row-val pos" id="bd_invest">‡ß≥ 0</span></div>
      <div class="breakdown-row"><span class="breakdown-row-label" data-i18n="business_bd">Business Assets</span><span class="breakdown-row-val pos" id="bd_biz">‡ß≥ 0</span></div>
      <div class="breakdown-row divider"><span class="breakdown-row-label" data-i18n="liabilities_bd">(-) Liabilities</span><span class="breakdown-row-val neg" id="bd_liab">‡ß≥ 0</span></div>
      <div class="breakdown-row divider"><span class="breakdown-row-label" data-i18n="net_zakatable">Net Zakatable Wealth</span><span class="breakdown-row-val total" id="bd_net">‡ß≥ 0</span></div>
      <div class="breakdown-row divider"><span class="breakdown-row-label" data-i18n="zakah_payable">Zakah Payable</span><span class="breakdown-row-val zakah" id="bd_zakah">‡ß≥ 0</span></div>
    </div>
  </div>

  <!-- ACTION BAR: PDF Export + Reset -->
  <div class="action-bar fade-up">
    <button class="btn-pdf" id="pdfExportBtn" onclick="exportZakatPDF()">
      <span class="btn-spin"></span>
      <span>‚¨á</span>
      <span class="btn-label" data-i18n="export_pdf">Export PDF</span>
    </button>
    <button class="btn-reset" onclick="resetAll()">‚Ü∫ <span data-i18n="reset_btn">Reset All Fields</span></button>
  </div>

</div>
</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SHARE MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="share-overlay" id="shareOverlay" role="dialog" aria-modal="true" aria-labelledby="shareModalTitle">
  <div class="share-modal">
    <div class="share-modal-header">
      <div class="share-modal-title-block">
        <div class="share-modal-icon">‚Üë</div>
        <div>
          <div class="share-modal-title" id="shareModalTitle" data-i18n="share_title">Share This Calculator</div>
          <div class="share-modal-desc" data-i18n="share_desc">Help others calculate their Zakah accurately</div>
        </div>
      </div>
      <button class="share-modal-close" onclick="closeShareModal()" aria-label="Close">‚úï</button>
    </div>
    <div class="share-modal-body">
      <!-- Copy Link -->
      <button class="share-option share-opt--copy" id="copyLinkBtn" onclick="shareCopyLink()">
        <div class="share-opt-icon">üîó</div>
        <span data-i18n="share_copy_link">Copy Link</span>
      </button>
      <!-- Facebook -->
      <button class="share-option share-opt--facebook" onclick="shareFacebook()">
        <div class="share-opt-icon">f</div>
        <span data-i18n="share_facebook">Facebook</span>
      </button>
      <!-- WhatsApp -->
      <button class="share-option share-opt--whatsapp" onclick="shareWhatsApp()">
        <div class="share-opt-icon">üí¨</div>
        <span data-i18n="share_whatsapp">WhatsApp</span>
      </button>
      <!-- More (Web Share API) -->
      <button class="share-option share-opt--more" onclick="shareMore()">
        <div class="share-opt-icon">‚ãØ</div>
        <span data-i18n="share_more">More‚Ä¶</span>
      </button>
    </div>
  </div>
</div>

<!-- PWA INSTALL BANNER -->
<div class="pwa-banner" id="pwaBanner" aria-live="polite" role="complementary" hidden>
  <div class="pwa-banner-inner">
    <div class="pwa-banner-left">
      <div class="pwa-banner-icon">‚òΩ</div>
      <div class="pwa-banner-text">
        <strong data-i18n="pwa_title">Install Zakah Calculator</strong>
        <span data-i18n="pwa_desc">Add to your home screen for offline access</span>
      </div>
    </div>
    <div class="pwa-banner-actions">
      <button class="pwa-btn-install" id="pwaBtnInstall" data-i18n="pwa_install">Install App</button>
      <button class="pwa-btn-dismiss" id="pwaBtnDismiss" aria-label="Dismiss">‚úï</button>
    </div>
  </div>
  <div class="pwa-ios-hint" id="pwaIosHint" hidden>
    <span data-i18n="pwa_ios_hint">Tap <strong>Share ‚¨Ü</strong> then <strong>"Add to Home Screen"</strong></span>
  </div>
</div>

<footer>
  <div class="footer-inner">
    <div class="footer-logo">‚òΩ Samin's Initiatives</div>
    <div class="footer-tagline" data-i18n="footer_tagline">Building tools for the Ummah with transparency and trust</div>
    <div class="footer-copy">
      ¬© <span id="footerYear"></span> <span>Samin's Initiatives</span> ¬∑ <span data-i18n="designed_by">Designed by</span> <span>Samin Yasar</span>
    </div>
    <div class="footer-links">
      <a href="./policies/privacy-notice" data-i18n="privacy">Privacy Policy</a>
      <a href="https://github.com/Samin-yasar/zakah" data-i18n="open_source">Open Source</a>
      <a href="https://samin-yasar.github.io/#contact" data-i18n="contact">Contact</a>
    </div>
    <div style="margin-top:12px;">
      <span class="badge-small">üîí <span data-i18n="local_processing">100% Local Processing</span></span>
      &nbsp;
      <span class="badge-small">üåê <span data-i18n="no_server">No Server Dependency</span></span>
      &nbsp;
      <span class="badge-small">‚ú¶ <span data-i18n="open_src_badge">Open Source</span></span>
    </div>
  </div>
</footer>

<!-- PDF export module (separate file, loaded before main script) -->
<script src="pdf-export.js"></script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LANGUAGE LOADER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentLang = localStorage.getItem('zakat_lang') || 'en';
let L = {};

function loadLang(lang, callback) {
  const old = document.getElementById('lang-script');
  if (old) old.remove();
  const s = document.createElement('script');
  s.id  = 'lang-script';
  s.src = `translations/${lang}.js`;
  s.onload = () => {
    L = window.LANG_DATA || {};
    if (callback) callback();
  };
  s.onerror = () => {
    console.warn(`[i18n] translations/${lang}.js not found, falling back to en`);
    if (lang !== 'en') loadLang('en', callback);
  };
  document.head.appendChild(s);
}

function applyLang(lang) {
  document.documentElement.lang = lang === 'bn' ? 'bn' : 'en';
  document.body.classList.toggle('lang-bn', lang === 'bn');

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (L[key] !== undefined) el.textContent = L[key];
  });
  document.querySelectorAll('[data-i18n-btn]').forEach(el => {
    const key = el.getAttribute('data-i18n-btn');
    if (L[key] !== undefined) el.textContent = L[key];
  });

  /* ‚îÄ‚îÄ Tooltip translation: set data-tip from language data ‚îÄ‚îÄ */
  document.querySelectorAll('[data-tip-key]').forEach(el => {
    const key = el.getAttribute('data-tip-key');
    if (L[key] !== undefined) el.setAttribute('data-tip', L[key]);
  });

  // Sync eligible badge
  const nwRaw    = parseFloat(document.getElementById('r_netWealth')?.textContent?.replace(/[^\d.]/g,'') || '0');
  const nisabRaw = parseFloat(document.getElementById('r_nisabVal')?.textContent?.replace(/[^\d.]/g,'')  || '9999999');
  const badge    = document.getElementById('eligibleBadge');
  if (badge) badge.textContent = nwRaw >= nisabRaw ? (L.eligible || 'Zakah Obligatory ‚úì') : (L.not_eligible || 'Not Eligible Yet');
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('zakat_lang', lang);
  document.getElementById('btn-en').classList.toggle('active', lang === 'en');
  document.getElementById('btn-bn').classList.toggle('active', lang === 'bn');
  loadLang(lang, () => { applyLang(lang); calc(); });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONSTANTS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TROY_OZ_TO_GRAM = 31.1035;
const BHORI_TO_GRAM   = 11.6638;
const CACHE_TTL_MS    = 24 * 60 * 60 * 1000;
const CURRENCY_SYMBOLS = { BDT:'‡ß≥', USD:'$', SAR:'Ô∑º', GBP:'¬£', AUD:'A$', INR:'‚Çπ' };
const METALS_URL = './data/metals.json';
const RATES_URL  = './data/rates.json';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentCurrency    = localStorage.getItem('zakat_currency') || 'BDT';
let nisabType          = 'silver';
let calendarType       = 'lunar';
let stockMethod        = 'trade';
let liveGoldUsdPerOz   = 0;
let liveSilverUsdPerOz = 0;
let fxRates            = {};
let pricesLive         = false;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CACHE HELPERS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function cacheWrite(key, data) {
  try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data })); } catch (_) {}
}
function cacheRead(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.ts > CACHE_TTL_MS) return null;
    return obj.data;
  } catch (_) { return null; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE PRICE FETCHING
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function fetchPrices(isManualRefresh = false) {
  const dot = document.getElementById('liveDot');
  const ts  = document.getElementById('priceTimestamp');
  const btn = document.getElementById('refreshBtn');

  dot.className = 'live-dot loading';
  ts.textContent = L.fetching || 'Fetching‚Ä¶';
  btn.disabled = true;
  btn.classList.add('spinning');
  setShimmer(true);

  if (!isManualRefresh) {
    const cached = cacheRead('zakat_metals');
    if (cached) {
      liveGoldUsdPerOz   = cached.gold;
      liveSilverUsdPerOz = cached.silver;
      const fxCached = cacheRead('zakat_fx');
      if (fxCached) {
        fxRates    = fxCached;
        pricesLive = true;
        onPricesReady('cache');
        return;
      }
    }
  }

  try {
    const [ratesRes, metalsRes] = await Promise.allSettled([
      fetch(RATES_URL,  { cache: 'no-cache' }),
      fetch(METALS_URL, { cache: 'no-cache' })
    ]);

    if (ratesRes.status === 'fulfilled' && ratesRes.value.ok) {
      const ratesData = await ratesRes.value.json();
      fxRates = ratesData.rates || ratesData;
    } else {
      throw new Error('rates.json unavailable');
    }

    let metalsOk = false;
    if (metalsRes.status === 'fulfilled' && metalsRes.value.ok) {
      const metalsData = await metalsRes.value.json();
      if (metalsData.gold_usd_per_oz && metalsData.silver_usd_per_oz) {
        liveGoldUsdPerOz   = metalsData.gold_usd_per_oz;
        liveSilverUsdPerOz = metalsData.silver_usd_per_oz;
        metalsOk = true;
      }
    }
    if (!metalsOk) throw new Error('Metal prices unavailable');

    cacheWrite('zakat_fx', fxRates);
    pricesLive = true;
    onPricesReady('live');

  } catch (err) {
    console.warn('Price fetch failed:', err.message);
    const staleMetal = (() => { try { const r = localStorage.getItem('zakat_metals'); return r ? JSON.parse(r).data : null; } catch(_) { return null; } })();
    const staleFx    = (() => { try { const r = localStorage.getItem('zakat_fx');     return r ? JSON.parse(r).data : null; } catch(_) { return null; } })();
    if (staleMetal && staleFx) {
      liveGoldUsdPerOz   = staleMetal.gold;
      liveSilverUsdPerOz = staleMetal.silver;
      fxRates            = staleFx;
      pricesLive         = true;
      onPricesReady('stale');
    } else {
      dot.className  = 'live-dot error';
      ts.textContent = L.price_error || 'Fetch failed ‚Äî using manual input';
      btn.disabled   = false;
      btn.classList.remove('spinning');
      setShimmer(false);
      showFallback();
      calc();
    }
  }
}

function onPricesReady(source) {
  const dot = document.getElementById('liveDot');
  const ts  = document.getElementById('priceTimestamp');
  const btn = document.getElementById('refreshBtn');
  dot.className  = 'live-dot';
  const now = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  const srcLabel = source === 'cache' ? ' (cached)' : source === 'stale' ? ' (stale cache)' : '';
  ts.textContent = `${L.price_updated || 'Updated'}: ${now}${srcLabel}`;
  btn.disabled   = false;
  btn.classList.remove('spinning');
  setShimmer(false);
  hideFallback();
  updatePriceDisplay();
  updateFxBanner();
  calc();
}

function setShimmer(on) {
  ['goldPriceDisplay','silverPriceDisplay','fxRateDisplay'].forEach(id => {
    document.getElementById(id)?.classList.toggle('loading-shimmer', on);
  });
}

function showFallback() {
  document.getElementById('manualFallback').classList.add('visible');
  document.getElementById('fxBanner').style.display = 'none';
  document.getElementById('metalSourceBadge').className = 'source-badge error';
  document.getElementById('fxSourceBadge').className    = 'source-badge error';
}
function hideFallback() {
  document.getElementById('manualFallback').classList.remove('visible');
  document.getElementById('metalSourceBadge').className = 'source-badge active';
  document.getElementById('fxSourceBadge').className    = 'source-badge active';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRICE HELPERS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getConvertedPrices() {
  if (!pricesLive) {
    return {
      goldPerGram:   parseFloat(document.getElementById('goldPriceManual')?.value   || 0) || 0,
      silverPerGram: parseFloat(document.getElementById('silverPriceManual')?.value || 0) || 0,
    };
  }
  const rate = fxRates[currentCurrency] || 1;
  return {
    goldPerGram:   (liveGoldUsdPerOz   / TROY_OZ_TO_GRAM) * rate,
    silverPerGram: (liveSilverUsdPerOz / TROY_OZ_TO_GRAM) * rate,
  };
}

function updatePriceDisplay() {
  if (!pricesLive) return;
  const { goldPerGram, silverPerGram } = getConvertedPrices();
  const sym  = CURRENCY_SYMBOLS[currentCurrency] || currentCurrency;
  const rate = fxRates[currentCurrency] || 1;

  document.getElementById('goldUsdLabel').textContent   = `$${liveGoldUsdPerOz.toFixed(2)} USD/oz`;
  document.getElementById('silverUsdLabel').textContent = `$${liveSilverUsdPerOz.toFixed(2)} USD/oz`;
  document.getElementById('fxBaseLabel').textContent    = `USD ‚Üí ${currentCurrency}`;
  document.getElementById('fxRateSub').textContent      = `1 USD = ${sym}${rate.toFixed(4)}`;
  document.getElementById('goldPriceDisplay').textContent   = `${sym} ${goldPerGram.toFixed(2)}`;
  document.getElementById('silverPriceDisplay').textContent = `${sym} ${silverPerGram.toFixed(2)}`;
  document.getElementById('fxRateDisplay').textContent      = `${rate.toFixed(4)}`;

  const isBDT = currentCurrency === 'BDT';
  const goldBhoriPrice   = goldPerGram   * BHORI_TO_GRAM;
  const silverBhoriPrice = silverPerGram * BHORI_TO_GRAM;
  document.getElementById('goldPerGramSub').textContent =
    isBDT ? `per gram ¬∑ ${sym}${goldBhoriPrice.toLocaleString('en-US', {maximumFractionDigits:0})} / ‡¶≠‡¶∞‡¶ø`
           : `per gram (${currentCurrency})`;
  document.getElementById('silverPerGramSub').textContent =
    isBDT ? `per gram ¬∑ ${sym}${silverBhoriPrice.toLocaleString('en-US', {maximumFractionDigits:0})} / ‡¶≠‡¶∞‡¶ø`
           : `per gram (${currentCurrency})`;
}

function updateFxBanner() {
  if (!pricesLive || !Object.keys(fxRates).length) return;
  const strip  = document.getElementById('fxRatesStrip');
  const banner = document.getElementById('fxBanner');
  const supported = ['BDT','USD','SAR','GBP','AUD','INR'];
  strip.innerHTML = supported.map(cur => {
    const r = fxRates[cur];
    if (!r) return '';
    const sym = CURRENCY_SYMBOLS[cur] || cur;
    return `<div class="fx-rate-item">${cur} <span>${sym}${r.toFixed(2)}</span></div>`;
  }).join('');
  banner.style.display = 'flex';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CURRENCY
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setCurrency(cur) {
  currentCurrency = cur;
  localStorage.setItem('zakat_currency', cur);
  updateCurrencySymbols();
  updatePriceDisplay();
  updateFxBanner();
  calc();
}

function updateCurrencySymbols() {
  const sym = CURRENCY_SYMBOLS[currentCurrency] || currentCurrency;
  document.querySelectorAll('.curr-pfx').forEach(el => el.textContent = sym);
  const pg = document.getElementById('pfxGold');
  const ps = document.getElementById('pfxSilver');
  if (pg) pg.textContent = sym;
  if (ps) ps.textContent = sym;
}

function fmt(n) {
  const sym = CURRENCY_SYMBOLS[currentCurrency] || currentCurrency;
  if (n === 0) return sym + ' 0';
  return sym + ' ' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SETTINGS TOGGLES
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setNisabType(type) {
  nisabType = type;
  document.getElementById('btn-silver').classList.toggle('active', type === 'silver');
  document.getElementById('btn-gold').classList.toggle('active',   type === 'gold');
  calc();
}
function setCalendar(type) {
  calendarType = type;
  document.getElementById('btn-lunar').classList.toggle('active', type === 'lunar');
  document.getElementById('btn-solar').classList.toggle('active', type === 'solar');
  calc();
}
function selectRadio(group, val, labelEl) {
  stockMethod = val;
  document.querySelectorAll('#stockMethodGroup .radio-btn').forEach(b => b.classList.remove('selected'));
  labelEl.classList.add('selected');
  calc();
}
function toggleSection(id) {
  document.getElementById(id).classList.toggle('open');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN CALCULATION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function v(id) {
  return parseFloat(document.getElementById(id)?.value || 0) || 0;
}

function calc() {
  const { goldPerGram, silverPerGram } = getConvertedPrices();

  const cashTotal =
    v('f_cashOnHand') + v('f_cashForeign') +
    v('f_bankSavings') + v('f_bankCurrent') + v('f_bankFD') +
    v('f_bkash')  + v('f_nagad') +
    v('f_upay')   + v('f_cellfin') +
    v('f_rocket') + v('f_paypal') + v('f_othersWallet') +
    v('f_moneyLent') + v('f_salaryDue');

  const gold24kEquiv =
    v('f_gold24k')   * (24/24) +
    v('f_gold22k')   * (22/24) +
    v('f_gold18k')   * (18/24) +
    v('f_gold21k')   * (21/24) +
    v('f_goldCoins') * 1;

  const goldValue   = gold24kEquiv * goldPerGram;
  const silverGrams = v('f_silverGrams') + v('f_silverBullion');
  const silverValue = silverGrams * silverPerGram;
  const metalTotal  = goldValue + silverValue;

  document.getElementById('goldValTotal').textContent      = fmt(goldValue);
  document.getElementById('silverValTotal').textContent    = fmt(silverValue);
  document.getElementById('metalValTotalDisp').textContent = fmt(metalTotal);

  const rawStocks = v('f_dseStocks') + v('f_intlStocks');
  const rawMutual = v('f_mutualFunds');
  const stocksVal = stockMethod === 'trade' ? rawStocks : rawStocks * 0.25;
  const mutualVal = stockMethod === 'trade' ? rawMutual : rawMutual * 0.25;
  const cryptoTotal  = v('f_btc') + v('f_eth') + v('f_otherCrypto');
  const pensionTotal = v('f_gpf') + v('f_nsc') + v('f_bonds') + v('f_otherInvest');
  const investTotal  = stocksVal + mutualVal + cryptoTotal + pensionTotal;

  const bizLiquid      = v('f_bizCash') + v('f_bizBank') + v('f_pettyCash');
  const bizInventory   = v('f_finishedGoods') + v('f_rawMaterials') + v('f_wip') + v('f_tradeGoods');
  const bizReceivables = v('f_tradeRec') + v('f_advancePaid') + v('f_secDeposit');
  const bizTotal       = bizLiquid + bizInventory + bizReceivables;

  const personalLiab =
    v('f_personalLoan') + v('f_creditCard') + v('f_mortgage12') +
    v('f_rentBills')    + v('f_taxesDue');
  const bizLiab =
    v('f_bizLoan') + v('f_tradePayables') + v('f_salariesPayable') + v('f_advanceReceived');
  const liabTotal = personalLiab + bizLiab;

  const totalAssets = cashTotal + metalTotal + investTotal + bizTotal;
  const netWealth   = Math.max(0, totalAssets - liabTotal);

  const SILVER_NISAB_G = 612.36;
  const GOLD_NISAB_G   = 87.48;
  const nisabValue = nisabType === 'silver'
    ? SILVER_NISAB_G * silverPerGram
    : GOLD_NISAB_G   * goldPerGram;

  const metalLabel = nisabType === 'silver' ? '612.36g Silver' : '87.48g Gold';
  document.getElementById('nisabMetalDisp').textContent = metalLabel;
  document.getElementById('nisabValueDisp').textContent = fmt(nisabValue);

  const zakahRate     = calendarType === 'lunar' ? 0.025 : 0.02577;
  const rateLabel     = calendarType === 'lunar' ? '2.5%' : '2.577%';
  const calendarLabel = calendarType === 'lunar' ? 'Lunar (Hijri)' : 'Solar (Gregorian)';
  document.getElementById('zakahRateDisp').textContent = rateLabel;

  const isEligible = nisabValue > 0 && netWealth >= nisabValue;
  const zakahDue   = isEligible ? netWealth * zakahRate : 0;

  const fieldIds = [
    'f_cashOnHand','f_cashForeign','f_bankSavings','f_bankCurrent','f_bankFD',
    'f_bkash','f_nagad','f_upay','f_cellfin','f_rocket','f_paypal','f_othersWallet',
    'f_moneyLent','f_salaryDue',
    'f_gold24k','f_gold22k','f_gold18k','f_gold21k','f_goldCoins',
    'f_silverGrams','f_silverBullion',
    'f_dseStocks','f_intlStocks','f_mutualFunds','f_btc','f_eth','f_otherCrypto',
    'f_gpf','f_nsc','f_bonds','f_otherInvest',
    'f_bizCash','f_bizBank','f_pettyCash',
    'f_finishedGoods','f_rawMaterials','f_wip','f_tradeGoods',
    'f_tradeRec','f_advancePaid','f_secDeposit',
    'f_personalLoan','f_creditCard','f_mortgage12','f_rentBills','f_taxesDue',
    'f_bizLoan','f_tradePayables','f_salariesPayable','f_advanceReceived'
  ];
  const filledCount = fieldIds.filter(id => v(id) > 0).length;
  document.getElementById('progressFill').style.width =
    Math.min(100, Math.round(filledCount / fieldIds.length * 100)) + '%';

  document.getElementById('tot-cash').textContent   = fmt(cashTotal);
  document.getElementById('tot-metals').textContent = fmt(metalTotal);
  document.getElementById('tot-invest').textContent = fmt(investTotal);
  document.getElementById('tot-biz').textContent    = fmt(bizTotal);
  document.getElementById('tot-liab').textContent   = fmt(liabTotal);

  document.getElementById('r_totalAssets').textContent = fmt(totalAssets);
  document.getElementById('r_totalLiab').textContent   = fmt(liabTotal);
  document.getElementById('r_netWealth').textContent   = fmt(netWealth);
  document.getElementById('r_nisabVal').textContent    = fmt(nisabValue);
  document.getElementById('r_nisabSub').textContent    = metalLabel;
  document.getElementById('r_rateApplied').textContent = rateLabel;
  document.getElementById('r_rateSub').textContent     = calendarLabel;
  document.getElementById('r_zakahDue').textContent    = fmt(zakahDue);

  const pct = nisabValue > 0 ? Math.min(100, (netWealth / nisabValue) * 100) : 0;
  document.getElementById('nisabBarFill').style.width = pct + '%';
  document.getElementById('nisabPct').textContent     = pct.toFixed(1) + '%';

  const badge = document.getElementById('eligibleBadge');
  badge.textContent = isEligible ? (L.eligible || 'Zakah Obligatory ‚úì') : (L.not_eligible || 'Not Eligible Yet');
  badge.className   = 'results-eligible ' + (isEligible ? 'yes' : 'no');
  document.getElementById('r_netWealth').className = 'result-stat-value ' + (isEligible ? 'green' : '');

  document.getElementById('bd_cash').textContent   = fmt(cashTotal);
  document.getElementById('bd_metals').textContent = fmt(metalTotal);
  document.getElementById('bd_invest').textContent = fmt(investTotal);
  document.getElementById('bd_biz').textContent    = fmt(bizTotal);
  document.getElementById('bd_liab').textContent   = fmt(liabTotal);
  document.getElementById('bd_net').textContent    = fmt(netWealth);
  document.getElementById('bd_zakah').textContent  = fmt(zakahDue);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESET
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetAll() {
  document.querySelectorAll('input[type="number"]').forEach(inp => inp.value = 0);
  calc();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SHARE MODAL
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openShareModal() {
  const overlay = document.getElementById('shareOverlay');
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
  // Focus close button for accessibility
  setTimeout(() => overlay.querySelector('.share-modal-close')?.focus(), 50);
}

function closeShareModal() {
  document.getElementById('shareOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// Close on backdrop click
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('shareOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeShareModal();
  });
  // Escape key
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeShareModal();
  });
});

function shareCopyLink() {
  const url = window.location.href;
  const btn = document.getElementById('copyLinkBtn');
  const label = btn.querySelector('[data-i18n]');
  navigator.clipboard.writeText(url).then(() => {
    btn.classList.add('copied');
    if (label) label.textContent = L.share_copied || 'Copied!';
    setTimeout(() => {
      btn.classList.remove('copied');
      if (label) label.textContent = L.share_copy_link || 'Copy Link';
    }, 2500);
  }).catch(() => {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = url;
    ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    btn.classList.add('copied');
    if (label) label.textContent = L.share_copied || 'Copied!';
    setTimeout(() => {
      btn.classList.remove('copied');
      if (label) label.textContent = L.share_copy_link || 'Copy Link';
    }, 2500);
  });
}

function shareFacebook() {
  const url = encodeURIComponent(window.location.href);
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
}

function shareWhatsApp() {
  const url  = window.location.href;
  const msg  = encodeURIComponent(`${L.share_whatsapp_msg || 'Calculate your Zakah accurately with this free, scholarly-precise calculator:'} ${url}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

function shareMore() {
  const shareData = {
    title: L.title || 'Zakah Calculator',
    text:  L.share_whatsapp_msg || 'Calculate your Zakah accurately with this free, scholarly-precise calculator:',
    url:   window.location.href,
  };
  if (navigator.share) {
    navigator.share(shareData).catch(err => {
      // User dismissed or error ‚Äî silent fail
      if (err.name !== 'AbortError') console.warn('[Share]', err);
    });
  } else {
    // Web Share API not available ‚Äî fallback to copy
    shareCopyLink();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PWA ‚Äî Service Worker & Install Prompt
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg  => console.info('[SW] Registered, scope:', reg.scope))
      .catch(err => console.warn('[SW] Registration failed:', err));
  });
}

let deferredPrompt = null;
const banner     = document.getElementById('pwaBanner');
const btnInstall = document.getElementById('pwaBtnInstall');
const btnDismiss = document.getElementById('pwaBtnDismiss');
const iosHint    = document.getElementById('pwaIosHint');

const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent) &&
              /safari/i.test(navigator.userAgent) &&
              !('standalone' in navigator && navigator.standalone);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                     navigator.standalone === true;

function wasDismissed() {
  const ts = parseInt(localStorage.getItem('pwa_dismissed') || '0', 10);
  return ts && (Date.now() - ts) < 30 * 24 * 60 * 60 * 1000;
}
function showBanner() { if (isStandalone || wasDismissed()) return; banner.hidden = false; if (isIos) iosHint.hidden = false; }
function hideBanner()  { banner.hidden = true; }

window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; setTimeout(showBanner, 3000); });
btnInstall?.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') hideBanner();
    deferredPrompt = null;
  }
});
btnDismiss?.addEventListener('click', () => { localStorage.setItem('pwa_dismissed', String(Date.now())); hideBanner(); });
if (isIos && !isStandalone) { setTimeout(showBanner, 3500); if (btnInstall) btnInstall.hidden = true; }
window.addEventListener('appinstalled', () => { hideBanner(); deferredPrompt = null; });

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('DOMContentLoaded', () => {
  const savedCur = localStorage.getItem('zakat_currency') || 'BDT';
  document.getElementById('currencySelect').value = savedCur;
  currentCurrency = savedCur;
  updateCurrencySymbols();

  document.getElementById('footerYear').textContent = new Date().getFullYear();

  document.getElementById('btn-en').classList.toggle('active', currentLang === 'en');
  document.getElementById('btn-bn').classList.toggle('active', currentLang === 'bn');

  loadLang(currentLang, () => {
    applyLang(currentLang);
    calc();
    fetchPrices();
  });
});
</script>
</body>
</html>
